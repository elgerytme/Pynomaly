# Generated branch-specific docker-compose file for branch: bugfix/security-patch
# Generated from: C:\Users\andre\pynomaly\deploy\docker\docker-compose.hardened.yml
# Branch suffix: bugfix-security-patch

version: '3.8'
services:
  pynomaly-dev-bugfix-security-patch:
    build:
      context: .
      dockerfile: Dockerfile.hardened
      target: development
    container_name: pynomaly-dev-bugfix-security-patch
    volumes:
    - ./src:/app/src:cached
    - ./tests:/app/tests:cached
    - ./pyproject.toml:/app/pyproject.toml:ro
    - pynomaly-dev-storage-bugfix-security-patch:/app/storage
    - pynomaly-dev-logs-bugfix-security-patch:/app/logs
    ports:
    - 8000:8000
    - 8888:8888
    environment:
    - PYNOMALY_ENV=development
    - PYNOMALY_LOG_LEVEL=DEBUG
    - REDIS_URL=redis://redis-bugfix-security-patch:6379
    - DATABASE_URL=postgresql://pynomaly:pynomaly@postgres-bugfix-security-patch:5432/pynomaly_dev
    - GIT_BRANCH=bugfix/security-patch
    depends_on:
    - redis-bugfix-security-patch
    - postgres-bugfix-security-patch
    networks:
    - pynomaly-network-bugfix-security-patch
    restart: unless-stopped
    security_opt:
    - no-new-privileges:true
    cap_drop:
    - ALL
    cap_add:
    - NET_BIND_SERVICE
  pynomaly-test-bugfix-security-patch:
    build:
      context: .
      dockerfile: Dockerfile.hardened
      target: testing
    container_name: pynomaly-test-bugfix-security-patch
    volumes:
    - ./src:/app/src:ro
    - ./tests:/app/tests:ro
    - ./pyproject.toml:/app/pyproject.toml:ro
    - pynomaly-test-reports-bugfix-security-patch:/app/htmlcov
    environment:
    - PYNOMALY_ENV=testing
    - PYNOMALY_LOG_LEVEL=DEBUG
    - REDIS_URL=redis://redis-test-bugfix-security-patch:6379
    - DATABASE_URL=postgresql://pynomaly:pynomaly@postgres-bugfix-security-patch-test:5432/pynomaly_test
    - GIT_BRANCH=bugfix/security-patch
    depends_on:
    - redis-test-bugfix-security-patch
    - postgres-test-bugfix-security-patch
    networks:
    - pynomaly-test-network-bugfix-security-patch
    profiles:
    - testing
    security_opt:
    - no-new-privileges:true
    cap_drop:
    - ALL
  pynomaly-prod-bugfix-security-patch:
    build:
      context: .
      dockerfile: Dockerfile.hardened
      target: production
    container_name: pynomaly-prod-bugfix-security-patch
    volumes:
    - pynomaly-prod-storage-bugfix-security-patch:/app/storage:rw
    - pynomaly-prod-logs-bugfix-security-patch:/app/logs:rw
    ports:
    - 80:8000
    environment:
    - PYNOMALY_ENV=production
    - PYNOMALY_LOG_LEVEL=INFO
    - REDIS_URL=redis://redis-prod-bugfix-security-patch:6379
    - DATABASE_URL=postgresql://pynomaly:${POSTGRES_PASSWORD}@postgres-bugfix-security-patch-prod:5432/pynomaly_prod
    - GIT_BRANCH=bugfix/security-patch
    depends_on:
    - redis-prod-bugfix-security-patch
    - postgres-prod-bugfix-security-patch
    networks:
    - pynomaly-prod-network-bugfix-security-patch
    profiles:
    - production
    restart: always
    security_opt:
    - no-new-privileges:true
    cap_drop:
    - ALL
    cap_add:
    - NET_BIND_SERVICE
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 1G
          cpus: '0.5'
  redis-bugfix-security-patch:
    image: redis:7.2-alpine
    container_name: pynomaly-redis-dev-bugfix-security-patch
    volumes:
    - pynomaly-redis-dev-data-bugfix-security-patch:/data
    ports:
    - 6379:6379
    networks:
    - pynomaly-network-bugfix-security-patch
    restart: unless-stopped
    security_opt:
    - no-new-privileges:true
    cap_drop:
    - ALL
    command: redis-server --requirepass pynomaly --appendonly yes
    environment:
    - GIT_BRANCH=bugfix/security-patch
  redis-test-bugfix-security-patch:
    image: redis:7.2-alpine
    container_name: pynomaly-redis-test-bugfix-security-patch
    tmpfs:
    - /data
    networks:
    - pynomaly-test-network-bugfix-security-patch
    profiles:
    - testing
    security_opt:
    - no-new-privileges:true
    cap_drop:
    - ALL
    command: redis-server --requirepass pynomaly
    environment:
    - GIT_BRANCH=bugfix/security-patch
  redis-prod-bugfix-security-patch:
    image: redis:7.2-alpine
    container_name: pynomaly-redis-prod-bugfix-security-patch
    volumes:
    - pynomaly-redis-prod-data-bugfix-security-patch:/data
    networks:
    - pynomaly-prod-network-bugfix-security-patch
    profiles:
    - production
    restart: always
    security_opt:
    - no-new-privileges:true
    cap_drop:
    - ALL
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes
    environment:
    - GIT_BRANCH=bugfix/security-patch
  postgres-bugfix-security-patch:
    image: postgres:15-alpine
    container_name: pynomaly-postgres-dev-bugfix-security-patch
    volumes:
    - pynomaly-postgres-dev-data-bugfix-security-patch:/var/lib/postgresql/data
    ports:
    - 5432:5432
    environment:
    - POSTGRES_DB=pynomaly_dev
    - POSTGRES_USER=pynomaly
    - POSTGRES_PASSWORD=pynomaly
    - GIT_BRANCH=bugfix/security-patch
    networks:
    - pynomaly-network-bugfix-security-patch
    restart: unless-stopped
    security_opt:
    - no-new-privileges:true
    cap_drop:
    - ALL
  postgres-test-bugfix-security-patch:
    image: postgres:15-alpine
    container_name: pynomaly-postgres-test-bugfix-security-patch
    tmpfs:
    - /var/lib/postgresql/data
    environment:
    - POSTGRES_DB=pynomaly_test
    - POSTGRES_USER=pynomaly
    - POSTGRES_PASSWORD=pynomaly
    - GIT_BRANCH=bugfix/security-patch
    networks:
    - pynomaly-test-network-bugfix-security-patch
    profiles:
    - testing
    security_opt:
    - no-new-privileges:true
    cap_drop:
    - ALL
  postgres-prod-bugfix-security-patch:
    image: postgres:15-alpine
    container_name: pynomaly-postgres-prod-bugfix-security-patch
    volumes:
    - pynomaly-postgres-prod-data-bugfix-security-patch:/var/lib/postgresql/data
    environment:
    - POSTGRES_DB=pynomaly_prod
    - POSTGRES_USER=pynomaly
    - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    - GIT_BRANCH=bugfix/security-patch
    networks:
    - pynomaly-prod-network-bugfix-security-patch
    profiles:
    - production
    restart: always
    security_opt:
    - no-new-privileges:true
    cap_drop:
    - ALL
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
  nginx-bugfix-security-patch:
    image: nginx:1.25-alpine
    container_name: pynomaly-nginx-bugfix-security-patch
    volumes:
    - ./nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
    - 443:443
    - 80:80
    depends_on:
    - pynomaly-prod-bugfix-security-patch
    networks:
    - pynomaly-prod-network-bugfix-security-patch
    profiles:
    - production
    restart: always
    security_opt:
    - no-new-privileges:true
    cap_drop:
    - ALL
    cap_add:
    - NET_BIND_SERVICE
    environment:
    - GIT_BRANCH=bugfix/security-patch
networks:
  pynomaly-network-bugfix-security-patch:
    driver: bridge
    name: pynomaly-dev-network-bugfix-security-patch
  pynomaly-test-network-bugfix-security-patch:
    driver: bridge
    name: pynomaly-test-network-bugfix-security-patch
  pynomaly-prod-network-bugfix-security-patch:
    driver: bridge
    name: pynomaly-prod-network-bugfix-security-patch
volumes:
  pynomaly-dev-storage-bugfix-security-patch:
    name: pynomaly-dev-storage-bugfix-security-patch
  pynomaly-dev-logs-bugfix-security-patch:
    name: pynomaly-dev-logs-bugfix-security-patch
  pynomaly-redis-dev-data-bugfix-security-patch:
    name: pynomaly-redis-dev-data-bugfix-security-patch
  pynomaly-postgres-dev-data-bugfix-security-patch:
    name: pynomaly-postgres-dev-data-bugfix-security-patch
  pynomaly-test-reports-bugfix-security-patch:
    name: pynomaly-test-reports-bugfix-security-patch
  pynomaly-prod-storage-bugfix-security-patch:
    name: pynomaly-prod-storage-bugfix-security-patch
  pynomaly-prod-logs-bugfix-security-patch:
    name: pynomaly-prod-logs-bugfix-security-patch
  pynomaly-redis-prod-data-bugfix-security-patch:
    name: pynomaly-redis-prod-data-bugfix-security-patch
  pynomaly-postgres-prod-data-bugfix-security-patch:
    name: pynomaly-postgres-prod-data-bugfix-security-patch
