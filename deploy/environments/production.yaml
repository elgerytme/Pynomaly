# Production Environment Configuration
# This file contains environment-specific settings for production deployment

apiVersion: v1
kind: ConfigMap
metadata:
  name: pynomaly-production-config
  namespace: pynomaly-production
  labels:
    app.kubernetes.io/name: pynomaly
    app.kubernetes.io/instance: production
    app.kubernetes.io/component: config
    environment: production
data:
  # Application Configuration
  PYNOMALY_ENV: "production"
  PYNOMALY_DEBUG: "false"
  PYNOMALY_LOG_LEVEL: "INFO"
  PYNOMALY_WORKERS: "4"
  PYNOMALY_MAX_WORKERS: "8"
  
  # Python Optimization
  PYTHONOPTIMIZE: "2"
  PYTHONUNBUFFERED: "1"
  PYTHONDONTWRITEBYTECODE: "1"
  PYTHONHASHSEED: "random"
  
  # Performance Tuning
  OMP_NUM_THREADS: "4"
  OPENBLAS_NUM_THREADS: "4"
  MKL_NUM_THREADS: "4"
  NUMEXPR_MAX_THREADS: "4"
  
  # Database Configuration
  DATABASE_POOL_SIZE: "20"
  DATABASE_MAX_OVERFLOW: "40"
  DATABASE_POOL_TIMEOUT: "30"
  DATABASE_POOL_RECYCLE: "3600"
  DATABASE_ECHO: "false"
  DATABASE_SSL_MODE: "require"
  DATABASE_CONNECT_TIMEOUT: "10"
  DATABASE_COMMAND_TIMEOUT: "30"
  
  # Cache Configuration
  CACHE_TYPE: "redis"
  CACHE_DEFAULT_TIMEOUT: "3600"
  CACHE_KEY_PREFIX: "pynomaly:prod:"
  CACHE_SERIALIZER: "pickle"
  REDIS_MAX_CONNECTIONS: "50"
  REDIS_RETRY_ON_TIMEOUT: "true"
  REDIS_SOCKET_KEEPALIVE: "true"
  REDIS_SOCKET_KEEPALIVE_OPTIONS: "1,3,5"
  
  # Security Configuration
  SECURE_HEADERS_ENABLED: "true"
  HSTS_MAX_AGE: "31536000"
  CONTENT_SECURITY_POLICY: "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https:; connect-src 'self' https:; frame-ancestors 'none'; form-action 'self'"
  X_FRAME_OPTIONS: "DENY"
  X_CONTENT_TYPE_OPTIONS: "nosniff"
  REFERRER_POLICY: "strict-origin-when-cross-origin"
  
  # CORS Configuration
  CORS_ORIGINS: "https://app.pynomaly.io,https://dashboard.pynomaly.io"
  CORS_METHODS: "GET,POST,PUT,DELETE,OPTIONS"
  CORS_HEADERS: "Content-Type,Authorization,X-API-Key"
  CORS_EXPOSE_HEADERS: "X-Request-ID,X-Response-Time"
  CORS_MAX_AGE: "86400"
  CORS_CREDENTIALS: "true"
  
  # Rate Limiting
  RATE_LIMIT_ENABLED: "true"
  RATE_LIMIT_STORAGE: "redis"
  RATE_LIMIT_STRATEGY: "moving-window"
  RATE_LIMIT_DEFAULT: "1000/hour"
  RATE_LIMIT_API_DEFAULT: "100/minute"
  RATE_LIMIT_AUTH_DEFAULT: "5/minute"
  
  # Authentication & Authorization
  JWT_ALGORITHM: "RS256"
  JWT_ACCESS_TOKEN_EXPIRES: "3600"
  JWT_REFRESH_TOKEN_EXPIRES: "604800"
  JWT_ISSUER: "pynomaly-api-prod"
  JWT_AUDIENCE: "pynomaly-clients"
  PASSWORD_MIN_LENGTH: "12"
  PASSWORD_REQUIRE_UPPERCASE: "true"
  PASSWORD_REQUIRE_LOWERCASE: "true"
  PASSWORD_REQUIRE_NUMBERS: "true"
  PASSWORD_REQUIRE_SYMBOLS: "true"
  SESSION_TIMEOUT: "3600"
  MAX_LOGIN_ATTEMPTS: "5"
  ACCOUNT_LOCKOUT_DURATION: "900"
  
  # API Configuration
  API_VERSION: "v1"
  API_TITLE: "Pynomaly API"
  API_DESCRIPTION: "Production Anomaly Detection API"
  API_DOCS_ENABLED: "false"
  API_REDOC_ENABLED: "false"
  API_OPENAPI_URL: ""
  MAX_REQUEST_SIZE: "100MB"
  REQUEST_TIMEOUT: "300"
  
  # File Upload Configuration
  UPLOAD_MAX_SIZE: "50MB"
  UPLOAD_ALLOWED_EXTENSIONS: "csv,json,parquet,pkl"
  UPLOAD_FOLDER: "/app/storage/uploads"
  UPLOAD_VIRUS_SCAN: "true"
  
  # Model Configuration
  MODEL_CACHE_SIZE: "100"
  MODEL_CACHE_TTL: "86400"
  MODEL_MAX_MEMORY: "2GB"
  MODEL_TIMEOUT: "300"
  MODEL_STORAGE_PATH: "/app/storage/models"
  MODEL_BACKUP_ENABLED: "true"
  MODEL_VERSIONING_ENABLED: "true"
  
  # Data Processing
  DATA_CHUNK_SIZE: "10000"
  DATA_MAX_ROWS: "1000000"
  DATA_MAX_COLUMNS: "1000"
  DATA_MEMORY_LIMIT: "4GB"
  DATA_PROCESSING_TIMEOUT: "1800"
  PANDAS_MEMORY_OPTIMIZE: "true"
  
  # Monitoring & Observability
  METRICS_ENABLED: "true"
  METRICS_PORT: "9090"
  METRICS_PATH: "/metrics"
  METRICS_REGISTRY: "prometheus"
  
  TRACING_ENABLED: "true"
  TRACING_SAMPLER: "probabilistic"
  TRACING_SAMPLE_RATE: "0.1"
  TRACING_SERVICE_NAME: "pynomaly-api"
  TRACING_SERVICE_VERSION: "1.0.0"
  
  LOGGING_LEVEL: "INFO"
  LOGGING_FORMAT: "json"
  LOGGING_CONSOLE_ENABLED: "true"
  LOGGING_FILE_ENABLED: "true"
  LOGGING_FILE_PATH: "/app/logs/pynomaly.log"
  LOGGING_FILE_MAX_SIZE: "100MB"
  LOGGING_FILE_BACKUP_COUNT: "5"
  LOGGING_STRUCTURED: "true"
  
  # Health Checks
  HEALTH_CHECK_ENABLED: "true"
  HEALTH_CHECK_DATABASE: "true"
  HEALTH_CHECK_CACHE: "true"
  HEALTH_CHECK_STORAGE: "true"
  HEALTH_CHECK_EXTERNAL_SERVICES: "true"
  HEALTH_CHECK_TIMEOUT: "10"
  
  # Backup & Recovery
  BACKUP_ENABLED: "true"
  BACKUP_SCHEDULE: "0 2 * * *"
  BACKUP_RETENTION_DAYS: "30"
  BACKUP_ENCRYPTION_ENABLED: "true"
  BACKUP_COMPRESSION_ENABLED: "true"
  BACKUP_VERIFICATION_ENABLED: "true"
  BACKUP_STORAGE_TYPE: "s3"
  BACKUP_S3_BUCKET: "pynomaly-prod-backups"
  BACKUP_S3_REGION: "us-west-2"
  
  # Feature Flags
  FEATURE_STREAMING_ENABLED: "true"
  FEATURE_BATCH_PROCESSING_ENABLED: "true"
  FEATURE_ML_PIPELINES_ENABLED: "true"
  FEATURE_EXPLAINABILITY_ENABLED: "true"
  FEATURE_AUTOML_ENABLED: "true"
  FEATURE_DRIFT_DETECTION_ENABLED: "true"
  FEATURE_ENSEMBLE_ENABLED: "true"
  FEATURE_FEDERATED_LEARNING_ENABLED: "false"
  FEATURE_QUANTUM_ALGORITHMS_ENABLED: "false"
  
  # Scaling Configuration
  AUTO_SCALING_ENABLED: "true"
  MIN_REPLICAS: "3"
  MAX_REPLICAS: "20"
  TARGET_CPU_UTILIZATION: "70"
  TARGET_MEMORY_UTILIZATION: "80"
  SCALE_UP_PODS: "2"
  SCALE_DOWN_PODS: "1"
  SCALE_UP_PERIOD: "60"
  SCALE_DOWN_PERIOD: "300"
  
  # Resource Limits
  MEMORY_REQUEST: "1Gi"
  MEMORY_LIMIT: "4Gi"
  CPU_REQUEST: "500m"
  CPU_LIMIT: "2000m"
  STORAGE_REQUEST: "20Gi"
  STORAGE_LIMIT: "100Gi"
  
  # Network Configuration
  SERVICE_MESH_ENABLED: "true"
  MTLS_ENABLED: "true"
  NETWORK_POLICIES_ENABLED: "true"
  INGRESS_CLASS: "nginx"
  LOAD_BALANCER_TYPE: "nlb"
  
  # Compliance & Governance
  AUDIT_LOGGING_ENABLED: "true"
  AUDIT_LOG_RETENTION_DAYS: "365"
  DATA_CLASSIFICATION_ENABLED: "true"
  PII_DETECTION_ENABLED: "true"
  GDPR_COMPLIANCE_ENABLED: "true"
  HIPAA_COMPLIANCE_ENABLED: "false"
  SOX_COMPLIANCE_ENABLED: "false"
  
  # Disaster Recovery
  DR_ENABLED: "true"
  DR_RTO_MINUTES: "30"
  DR_RPO_MINUTES: "5"
  DR_REGION: "us-east-1"
  DR_CROSS_REGION_BACKUP: "true"
  DR_AUTOMATED_FAILOVER: "false"
  
  # Chaos Engineering
  CHAOS_ENGINEERING_ENABLED: "true"
  CHAOS_EXPERIMENT_SCHEDULE: "0 3 * * 1"
  CHAOS_BLAST_RADIUS: "small"
  CHAOS_MONITORING_ENABLED: "true"
  
  # External Services
  EXTERNAL_ML_SERVICES_ENABLED: "true"
  THIRD_PARTY_INTEGRATIONS_ENABLED: "true"
  WEBHOOK_ENABLED: "true"
  WEBHOOK_TIMEOUT: "30"
  WEBHOOK_RETRY_ATTEMPTS: "3"
  
  # Development & Debugging
  PROFILING_ENABLED: "false"
  DEBUG_TOOLBAR_ENABLED: "false"
  QUERY_DEBUGGING_ENABLED: "false"
  PERFORMANCE_MONITORING_ENABLED: "true"
  
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: pynomaly-production-ml-config
  namespace: pynomaly-production
  labels:
    app.kubernetes.io/name: pynomaly
    app.kubernetes.io/instance: production
    app.kubernetes.io/component: ml-config
    environment: production
data:
  # Machine Learning Configuration
  ML_BACKEND: "sklearn,pytorch,tensorflow"
  ML_DEVICE: "auto"
  ML_PRECISION: "float32"
  ML_RANDOM_SEED: "42"
  
  # Algorithm Configuration
  ISOLATION_FOREST_N_ESTIMATORS: "200"
  ISOLATION_FOREST_MAX_SAMPLES: "auto"
  ISOLATION_FOREST_CONTAMINATION: "0.1"
  
  ONE_CLASS_SVM_GAMMA: "scale"
  ONE_CLASS_SVM_KERNEL: "rbf"
  ONE_CLASS_SVM_NU: "0.1"
  
  LOCAL_OUTLIER_FACTOR_N_NEIGHBORS: "20"
  LOCAL_OUTLIER_FACTOR_ALGORITHM: "auto"
  LOCAL_OUTLIER_FACTOR_CONTAMINATION: "0.1"
  
  # Deep Learning Configuration
  AUTOENCODER_EPOCHS: "100"
  AUTOENCODER_BATCH_SIZE: "256"
  AUTOENCODER_LEARNING_RATE: "0.001"
  AUTOENCODER_HIDDEN_NEURONS: "128,64,32"
  
  VAE_LATENT_DIM: "20"
  VAE_EPOCHS: "150"
  VAE_BATCH_SIZE: "128"
  VAE_BETA: "1.0"
  
  # AutoML Configuration
  AUTOML_TIME_BUDGET: "3600"
  AUTOML_METRIC: "average_precision"
  AUTOML_ESTIMATOR_LIST: "isolation_forest,one_class_svm,lof"
  AUTOML_CROSS_VALIDATION: "5"
  
  # Ensemble Configuration
  ENSEMBLE_VOTING_METHOD: "average"
  ENSEMBLE_WEIGHTS_AUTO: "true"
  ENSEMBLE_MIN_ESTIMATORS: "3"
  ENSEMBLE_MAX_ESTIMATORS: "10"
  
  # Preprocessing Configuration
  PREPROCESSING_SCALING: "standard"
  PREPROCESSING_ENCODING: "onehot"
  PREPROCESSING_MISSING_VALUES: "median"
  PREPROCESSING_OUTLIER_REMOVAL: "false"
  
  # Feature Engineering
  FEATURE_SELECTION_ENABLED: "true"
  FEATURE_SELECTION_METHOD: "mutual_info"
  FEATURE_SELECTION_K_BEST: "auto"
  
  # Model Validation
  VALIDATION_METHOD: "time_series_split"
  VALIDATION_TEST_SIZE: "0.2"
  VALIDATION_RANDOM_STATE: "42"
  
  # Drift Detection
  DRIFT_DETECTION_METHOD: "ks_test"
  DRIFT_DETECTION_THRESHOLD: "0.05"
  DRIFT_DETECTION_WINDOW_SIZE: "1000"
  
  # Explainability
  SHAP_EXPLAINER: "tree"
  SHAP_MAX_DISPLAY: "20"
  LIME_NUM_FEATURES: "10"
  LIME_NUM_SAMPLES: "5000"

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: pynomaly-production-alerts
  namespace: pynomaly-production
  labels:
    app.kubernetes.io/name: pynomaly
    app.kubernetes.io/instance: production
    app.kubernetes.io/component: alerts
    environment: production
data:
  alerts.yaml: |
    groups:
    - name: pynomaly_production_critical
      interval: 30s
      rules:
      - alert: PynomalyAPIDown
        expr: up{job="pynomaly-api"} == 0
        for: 1m
        labels:
          severity: critical
          environment: production
          service: api
        annotations:
          summary: "Pynomaly API is down"
          description: "Pynomaly API has been down for more than 1 minute"
          runbook_url: "https://runbooks.pynomaly.io/api-down"
          
      - alert: PynomalyHighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.05
        for: 2m
        labels:
          severity: critical
          environment: production
          service: api
        annotations:
          summary: "High error rate in Pynomaly API"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%)"
          runbook_url: "https://runbooks.pynomaly.io/high-error-rate"
          
      - alert: PynomalyDatabaseConnectionFailed
        expr: pynomaly_database_connections_failed_total > 10
        for: 1m
        labels:
          severity: critical
          environment: production
          service: database
        annotations:
          summary: "Database connection failures"
          description: "{{ $value }} database connection failures detected"
          runbook_url: "https://runbooks.pynomaly.io/database-issues"
          
    - name: pynomaly_production_warning
      interval: 1m
      rules:
      - alert: PynomalyHighLatency
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
        for: 5m
        labels:
          severity: warning
          environment: production
          service: api
        annotations:
          summary: "High latency in Pynomaly API"
          description: "95th percentile latency is {{ $value }}s (threshold: 2s)"
          runbook_url: "https://runbooks.pynomaly.io/high-latency"
          
      - alert: PynomalyMemoryUsageHigh
        expr: container_memory_working_set_bytes{pod=~"pynomaly-.*"} / container_spec_memory_limit_bytes > 0.85
        for: 10m
        labels:
          severity: warning
          environment: production
          service: api
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ $value | humanizePercentage }} (threshold: 85%)"
          runbook_url: "https://runbooks.pynomaly.io/high-memory"
          
      - alert: PynomaliyCPUUsageHigh
        expr: rate(container_cpu_usage_seconds_total{pod=~"pynomaly-.*"}[5m]) > 0.9
        for: 15m
        labels:
          severity: warning
          environment: production
          service: api
        annotations:
          summary: "High CPU usage"
          description: "CPU usage is {{ $value | humanizePercentage }} (threshold: 90%)"
          runbook_url: "https://runbooks.pynomaly.io/high-cpu"
          
      - alert: PynomalyModelTrainingFailed
        expr: increase(pynomaly_model_training_failures_total[1h]) > 5
        for: 0m
        labels:
          severity: warning
          environment: production
          service: ml
        annotations:
          summary: "Multiple model training failures"
          description: "{{ $value }} model training failures in the last hour"
          runbook_url: "https://runbooks.pynomaly.io/model-training-failures"