(()=>{var D=(a,s)=>()=>(s||a((s={exports:{}}).exports,s),s.exports);var F=D((N,h)=>{var d=class{constructor(s){this.state={},this.listeners=new Set,this.middlewares=[],this.slices=new Map,this.persistConfig=null;let e=this.createSetState(),t=()=>this.state;this.state=s(e,t,this),this.loadPersistedState()}createSetState(){return(s,e=!1)=>{let t=typeof s=="function"?s(this.state):s,i=this.state;this.state=e?t:{...this.state,...t},this.middlewares.forEach(o=>{o(this.state,i,this)}),this.persistState(),this.listeners.forEach(o=>o(this.state,i))}}subscribe(s){return this.listeners.add(s),()=>this.listeners.delete(s)}getState(){return this.state}addMiddleware(s){this.middlewares.push(s)}addSlice(s,e){this.slices.set(s,e)}getSlice(s){return this.slices.get(s)}configurePersistence(s){this.persistConfig=s}persistState(){if(this.persistConfig)try{let{key:s,storage:e=localStorage,whitelist:t,blacklist:i}=this.persistConfig,o=this.state;t&&(o=Object.keys(this.state).filter(r=>t.includes(r)).reduce((r,c)=>(r[c]=this.state[c],r),{})),i&&(o=Object.keys(this.state).filter(r=>!i.includes(r)).reduce((r,c)=>(r[c]=this.state[c],r),{})),e.setItem(s,JSON.stringify(o))}catch(s){console.warn("Failed to persist state:",s)}}loadPersistedState(){if(this.persistConfig)try{let{key:s,storage:e=localStorage}=this.persistConfig,t=e.getItem(s);if(t){let i=JSON.parse(t);this.state={...this.state,...i}}}catch(s){console.warn("Failed to load persisted state:",s)}}},R=(a,s)=>({ui:{theme:"light",sidebarOpen:!0,loading:!1,notifications:[],modal:null,activeView:"dashboard",layout:"default"},user:{isAuthenticated:!1,profile:null,preferences:{chartAnimations:!0,realTimeUpdates:!0,accessibilityMode:!1,dataRefreshInterval:3e4},permissions:[]},data:{datasets:[],models:[],detectionResults:[],performanceMetrics:[],realTimeData:{isConnected:!1,lastUpdate:null,buffer:[]}},charts:{instances:new Map,configurations:{},themes:{light:{},dark:{}},activeFilters:{},selectedData:null},dashboard:{layout:[],widgets:{},filters:{},refreshInterval:3e4,autoRefresh:!1},setTheme:e=>a(t=>({ui:{...t.ui,theme:e}})),toggleSidebar:()=>a(e=>({ui:{...e.ui,sidebarOpen:!e.ui.sidebarOpen}})),setLoading:e=>a(t=>({ui:{...t.ui,loading:e}})),addNotification:e=>a(t=>({ui:{...t.ui,notifications:[...t.ui.notifications,{id:Date.now(),timestamp:new Date().toISOString(),...e}]}})),removeNotification:e=>a(t=>({ui:{...t.ui,notifications:t.ui.notifications.filter(i=>i.id!==e)}})),showModal:e=>a(t=>({ui:{...t.ui,modal:e}})),hideModal:()=>a(e=>({ui:{...e.ui,modal:null}})),setActiveView:e=>a(t=>({ui:{...t.ui,activeView:e}})),setUser:e=>a(t=>({user:{...t.user,...e}})),updateUserPreferences:e=>a(t=>({user:{...t.user,preferences:{...t.user.preferences,...e}}})),setDatasets:e=>a(t=>({data:{...t.data,datasets:e}})),addDataset:e=>a(t=>({data:{...t.data,datasets:[...t.data.datasets,e]}})),updateDataset:(e,t)=>a(i=>({data:{...i.data,datasets:i.data.datasets.map(o=>o.id===e?{...o,...t}:o)}})),removeDataset:e=>a(t=>({data:{...t.data,datasets:t.data.datasets.filter(i=>i.id!==e)}})),setModels:e=>a(t=>({data:{...t.data,models:e}})),addDetectionResult:e=>a(t=>({data:{...t.data,detectionResults:[...t.data.detectionResults,e]}})),updatePerformanceMetrics:e=>a(t=>({data:{...t.data,performanceMetrics:[...t.data.performanceMetrics,e]}})),setRealTimeConnection:e=>a(t=>({data:{...t.data,realTimeData:{...t.data.realTimeData,isConnected:e,lastUpdate:e?new Date().toISOString():t.data.realTimeData.lastUpdate}}})),addRealTimeData:e=>a(t=>{let o=[...t.data.realTimeData.buffer,e].slice(-1e3);return{data:{...t.data,realTimeData:{...t.data.realTimeData,buffer:o,lastUpdate:new Date().toISOString()}}}}),clearRealTimeBuffer:()=>a(e=>({data:{...e.data,realTimeData:{...e.data.realTimeData,buffer:[]}}})),registerChart:(e,t)=>a(i=>{let o=new Map(i.charts.instances);return o.set(e,t),{charts:{...i.charts,instances:o}}}),unregisterChart:e=>a(t=>{let i=new Map(t.charts.instances);return i.delete(e),{charts:{...t.charts,instances:i}}}),updateChartConfiguration:(e,t)=>a(i=>({charts:{...i.charts,configurations:{...i.charts.configurations,[e]:{...i.charts.configurations[e],...t}}}})),setActiveFilters:e=>a(t=>({charts:{...t.charts,activeFilters:e}})),setSelectedData:e=>a(t=>({charts:{...t.charts,selectedData:e}})),updateDashboardLayout:e=>a(t=>({dashboard:{...t.dashboard,layout:e}})),addWidget:e=>a(t=>({dashboard:{...t.dashboard,widgets:{...t.dashboard.widgets,[e.id]:e}}})),updateWidget:(e,t)=>a(i=>({dashboard:{...i.dashboard,widgets:{...i.dashboard.widgets,[e]:{...i.dashboard.widgets[e],...t}}}})),removeWidget:e=>a(t=>{let i={...t.dashboard.widgets};return delete i[e],{dashboard:{...t.dashboard,widgets:i}}}),setDashboardFilters:e=>a(t=>({dashboard:{...t.dashboard,filters:e}})),setAutoRefresh:e=>a(t=>({dashboard:{...t.dashboard,autoRefresh:e}})),setRefreshInterval:e=>a(t=>({dashboard:{...t.dashboard,refreshInterval:e}}))}),n=new d(R);n.configurePersistence({key:"pynomaly-app-state",storage:localStorage,whitelist:["user","dashboard","ui"],blacklist:["data.realTimeData"]});var k=(a,s,e)=>{},T=(a,s,e)=>{a.ui.activeView!==s.ui.activeView&&window.gtag&&window.gtag("event","page_view",{page_title:a.ui.activeView,page_location:window.location.href}),a.data.detectionResults.length>s.data.detectionResults.length&&window.gtag&&window.gtag("event","anomaly_detected",{custom_parameter:a.data.detectionResults.length})},M=(a,s,e)=>{let t=document.getElementById("state-announcer")||document.querySelector('[aria-live="polite"]');t&&(a.ui.loading!==s.ui.loading&&(a.ui.loading?t.textContent="Loading data, please wait":t.textContent="Data loaded successfully"),a.ui.notifications.length>s.ui.notifications.length&&a.ui.notifications.slice(s.ui.notifications.length).forEach(o=>{t.textContent=`${o.type}: ${o.message}`}),a.data.realTimeData.isConnected!==s.data.realTimeData.isConnected&&(t.textContent=a.data.realTimeData.isConnected?"Real-time data connection established":"Real-time data connection lost"))};n.addMiddleware(k);n.addMiddleware(T);n.addMiddleware(M);var A=(a,s)=>({selectedPoints:[],hoveredPoint:null,brushSelection:null,zoomLevel:1,filters:{timeRange:null,confidenceThreshold:0,anomalyTypes:[]},interactions:{brushEnabled:!0,zoomEnabled:!0,tooltipsEnabled:!0},selectPoints:e=>a(t=>({selectedPoints:e})),setHoveredPoint:e=>a(t=>({hoveredPoint:e})),setBrushSelection:e=>a(t=>({brushSelection:e})),setZoomLevel:e=>a(t=>({zoomLevel:e})),updateFilters:e=>a(t=>({filters:{...t.filters,...e}})),resetFilters:()=>a(e=>({filters:{timeRange:null,confidenceThreshold:0,anomalyTypes:[]}})),setInteractions:e=>a(t=>({interactions:{...t.interactions,...e}}))}),f=new d(A);n.addSlice("charts",f);var C=(a,s)=>({forms:{},validations:{},submissions:{},createForm:(e,t={})=>a(i=>({forms:{...i.forms,[e]:{id:e,data:t,touched:{},errors:{},isValid:!0,isSubmitting:!1,isDirty:!1}}})),updateFormField:(e,t,i)=>a(o=>{let r=o.forms[e];if(!r)return o;let c={...r.data,[t]:i},y={...r.touched,[t]:!0},w=o.validations[e],b=w?w(c):{},v=Object.keys(b).length===0;return{forms:{...o.forms,[e]:{...r,data:c,touched:y,errors:b,isValid:v,isDirty:!0}}}}),setFormValidation:(e,t)=>a(i=>({validations:{...i.validations,[e]:t}})),setFormSubmitting:(e,t)=>a(i=>({forms:{...i.forms,[e]:{...i.forms[e],isSubmitting:t}}})),resetForm:e=>a(t=>{let i=t.forms[e];return i?{forms:{...t.forms,[e]:{...i,touched:{},errors:{},isValid:!0,isSubmitting:!1,isDirty:!1}}}:t}),removeForm:e=>a(t=>{let i={...t.forms},o={...t.validations},r={...t.submissions};return delete i[e],delete o[e],delete r[e],{forms:i,validations:o,submissions:r}})}),g=new d(C);n.addSlice("forms",g);var l=class{constructor(s){this.store=s,this.websocket=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=1e3,this.heartbeatInterval=null}connect(s="ws://localhost:8000/ws"){try{this.websocket=new WebSocket(s),this.setupEventListeners()}catch(e){console.error("Failed to connect to WebSocket:",e),this.store.getState().setRealTimeConnection(!1)}}setupEventListeners(){this.websocket.onopen=()=>{console.log("WebSocket connected"),this.store.getState().setRealTimeConnection(!0),this.reconnectAttempts=0,this.startHeartbeat()},this.websocket.onmessage=s=>{try{let e=JSON.parse(s.data);this.handleMessage(e)}catch(e){console.error("Failed to parse WebSocket message:",e)}},this.websocket.onclose=()=>{console.log("WebSocket disconnected"),this.store.getState().setRealTimeConnection(!1),this.stopHeartbeat(),this.attemptReconnect()},this.websocket.onerror=s=>{console.error("WebSocket error:",s),this.store.getState().addNotification({type:"error",message:"Real-time connection error",duration:5e3})}}handleMessage(s){let{type:e,payload:t}=s;switch(e){case"anomaly_detected":this.store.getState().addDetectionResult(t),this.store.getState().addNotification({type:"warning",message:`Anomaly detected: ${t.type}`,duration:1e4});break;case"performance_update":this.store.getState().updatePerformanceMetrics(t),this.store.getState().addRealTimeData(t);break;case"system_alert":this.store.getState().addNotification({type:t.severity,message:t.message,duration:t.severity==="error"?0:5e3});break;case"data_update":this.store.getState().addRealTimeData(t);break;default:console.warn("Unknown message type:",e)}}startHeartbeat(){this.heartbeatInterval=setInterval(()=>{this.websocket.readyState===WebSocket.OPEN&&this.websocket.send(JSON.stringify({type:"ping"}))},3e4)}stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null)}attemptReconnect(){if(this.reconnectAttempts<this.maxReconnectAttempts){this.reconnectAttempts++;let s=this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);setTimeout(()=>{console.log(`Attempting to reconnect (${this.reconnectAttempts}/${this.maxReconnectAttempts})`),this.connect()},s)}else console.error("Max reconnection attempts reached"),this.store.getState().addNotification({type:"error",message:"Real-time connection failed. Please refresh the page.",duration:0})}disconnect(){this.websocket&&(this.websocket.close(),this.websocket=null),this.stopHeartbeat()}send(s){this.websocket&&this.websocket.readyState===WebSocket.OPEN?this.websocket.send(JSON.stringify(s)):console.warn("WebSocket not connected")}},m=a=>{let s=n.getState();return a?a(s):s},S=(a,s)=>n.subscribe((t,i)=>{let o=a(t),r=a(i);o!==r&&s(o,r)}),u={getTheme:a=>a.ui.theme,getLoading:a=>a.ui.loading,getNotifications:a=>a.ui.notifications,getActiveView:a=>a.ui.activeView,getUser:a=>a.user,getUserPreferences:a=>a.user.preferences,isAuthenticated:a=>a.user.isAuthenticated,getDatasets:a=>a.data.datasets,getModels:a=>a.data.models,getDetectionResults:a=>a.data.detectionResults,getPerformanceMetrics:a=>a.data.performanceMetrics,getRealTimeData:a=>a.data.realTimeData,getRecentAnomalies:a=>{let s=new Date(Date.now()-864e5);return a.data.detectionResults.filter(e=>new Date(e.timestamp)>s)},getHighConfidenceAnomalies:a=>a.data.detectionResults.filter(s=>s.confidence>.8),getAnomalyTypeDistribution:a=>{let s={};return a.data.detectionResults.forEach(e=>{let t=e.type||"Unknown";s[t]=(s[t]||0)+1}),s},getSystemHealth:a=>{let s=u.getRecentAnomalies(a),e=s.filter(t=>t.confidence>.95).length;return e>5?"critical":e>2?"warning":s.length>10?"caution":"good"},getChartInstances:a=>a.charts.instances,getActiveFilters:a=>a.charts.activeFilters,getSelectedData:a=>a.charts.selectedData,getDashboardLayout:a=>a.dashboard.layout,getDashboardWidgets:a=>a.dashboard.widgets,getDashboardFilters:a=>a.dashboard.filters,isAutoRefreshEnabled:a=>a.dashboard.autoRefresh},p=new l(n);document.addEventListener("DOMContentLoaded",()=>{m(u.getUserPreferences).realTimeUpdates&&p.connect()});typeof h<"u"&&h.exports?h.exports={StateStore:d,appStore:n,chartStore:f,formStore:g,RealTimeManager:l,realTimeManager:p,useStore:m,useStoreSubscription:S,selectors:u}:(window.StateStore=d,window.appStore=n,window.chartStore=f,window.formStore=g,window.RealTimeManager=l,window.realTimeManager=p,window.useStore=m,window.useStoreSubscription=S,window.selectors=u)});F();})();
