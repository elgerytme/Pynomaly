<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Pynomaly - State-of-the-art anomaly detection platform" />
    
    <!-- Security Meta Tags -->
    <meta name="csrf-token" content="{{ csrf_token() }}" />
    <meta name="csrf-param" content="csrf_token" />
    <meta name="robots" content="noindex, nofollow" />
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3B82F6" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Pynomaly" />
    
    <!-- Security Headers in Meta Tags (fallback) -->
    <meta http-equiv="X-Frame-Options" content="DENY" />
    <meta http-equiv="X-Content-Type-Options" content="nosniff" />
    <meta http-equiv="X-XSS-Protection" content="1; mode=block" />
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin" />
    
    <!-- CSP Meta Tag (development fallback) -->
    {% if config.DEBUG %}
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'nonce-{{ csp_nonce() }}' https://cdn.tailwindcss.com https://unpkg.com;
        style-src 'self' 'nonce-{{ csp_nonce() }}' https://cdn.tailwindcss.com;
        img-src 'self' data: blob:;
        font-src 'self' data:;
        connect-src 'self' ws: wss: http://localhost:* ws://localhost:*;
        media-src 'self';
        object-src 'none';
        frame-src 'none';
        frame-ancestors 'none';
        form-action 'self';
        base-uri 'self';
        upgrade-insecure-requests;
    " />
    {% endif %}
    
    <title>{% block title %}Pynomaly{% endblock %}</title>
    
    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/png" href="/static/img/favicon.png" />
    <link rel="shortcut icon" href="/static/img/favicon.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/static/img/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/static/img/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/static/img/favicon-16x16.png" />
    <link rel="manifest" href="/static/manifest.json" />
    
    <!-- Preload Critical Resources -->
    <link rel="preload" href="/static/css/output.css" as="style" />
    <link rel="preload" href="/static/js/dist/main.js" as="script" />
    
    <!-- DNS Prefetch for Trusted CDNs -->
    <link rel="dns-prefetch" href="//cdn.tailwindcss.com" />
    <link rel="dns-prefetch" href="//unpkg.com" />
    
    <!-- Preconnect to Trusted CDNs -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin />
    <link rel="preconnect" href="https://unpkg.com" crossorigin />
    
    <!-- Local CSS -->
    <link rel="stylesheet" href="/static/css/output.css" />
    
    <!-- Tailwind CSS with SRI -->
    {{ sri_link('https://cdn.tailwindcss.com', id='tailwind-css') | safe }}
    
    <!-- Tailwind Configuration (with nonce) -->
    <script nonce="{{ csp_nonce() }}">
        // Secure Tailwind configuration
        window.tailwind = window.tailwind || {};
        window.tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: "#3B82F6",
                        secondary: "#10B981", 
                        accent: "#F59E0B",
                        error: "#EF4444",
                        anomaly: {
                            50: "#fef2f2",
                            100: "#fee2e2",
                            500: "#ef4444",
                            600: "#dc2626",
                            700: "#b91c1c"
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            },
            darkMode: 'class'
        };
    </script>
    
    <!-- HTMX with SRI -->
    {{ sri_script('https://unpkg.com/htmx.org@1.9.10', defer=true) | safe }}
    
    <!-- HTMX Extensions -->
    {{ sri_script('https://unpkg.com/htmx.org/dist/ext/json-enc.js', defer=true) | safe }}
    
    <!-- Alpine.js with SRI -->
    {{ sri_script('https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js', defer=true) | safe }}
    
    <!-- Custom Application Scripts -->
    <script src="/static/js/dist/main.js" defer></script>
    
    <!-- Enhanced Security Manager -->
    <script src="/static/js/src/utils/security-enhanced.js" nonce="{{ csp_nonce() }}" defer></script>
    
    <!-- Application Initialization (with nonce) -->
    <script nonce="{{ csp_nonce() }}">
        // Secure application initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize HTMX with security headers
            if (typeof htmx !== 'undefined') {
                htmx.config.requestClass = 'htmx-request';
                htmx.config.addedClass = 'htmx-added';
                htmx.config.settlingClass = 'htmx-settling';
                htmx.config.swappingClass = 'htmx-swapping';
                
                // Add CSRF token to all HTMX requests
                htmx.on('htmx:configRequest', function(evt) {
                    const csrfToken = document.querySelector('meta[name="csrf-token"]');
                    if (csrfToken) {
                        evt.detail.headers['X-CSRFToken'] = csrfToken.getAttribute('content');
                    }
                });
                
                // Security event handling
                htmx.on('htmx:responseError', function(evt) {
                    console.error('HTMX Response Error:', evt.detail);
                    if (window.enhancedSecurityManager) {
                        window.enhancedSecurityManager.reportSecurityEvent('htmx_error', {
                            status: evt.detail.xhr.status,
                            url: evt.detail.pathInfo.requestPath
                        });
                    }
                });
            }
            
            // Initialize enhanced security manager
            if (window.enhancedSecurityManager) {
                console.log('ðŸ”’ Enhanced Security Manager active');
            }
            
            // Initialize theme management
            const savedTheme = localStorage.getItem('theme');
            const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            const theme = savedTheme || systemTheme;
            
            document.documentElement.setAttribute('data-theme', theme);
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            }
            
            // Listen for theme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
                if (!localStorage.getItem('theme')) {
                    const newTheme = e.matches ? 'dark' : 'light';
                    document.documentElement.setAttribute('data-theme', newTheme);
                    document.documentElement.classList.toggle('dark', newTheme === 'dark');
                }
            });
        });
        
        // Global error handler for security monitoring
        window.addEventListener('error', function(evt) {
            if (window.enhancedSecurityManager) {
                window.enhancedSecurityManager.reportSecurityEvent('javascript_error', {
                    message: evt.message,
                    filename: evt.filename,
                    lineno: evt.lineno,
                    colno: evt.colno
                });
            }
        });
        
        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', function(evt) {
            if (window.enhancedSecurityManager) {
                window.enhancedSecurityManager.reportSecurityEvent('unhandled_promise_rejection', {
                    reason: evt.reason?.toString() || 'Unknown error'
                });
            }
        });
    </script>
    
    <!-- Critical CSS (inline with hash) -->
    <style nonce="{{ csp_nonce() }}">
        /* Critical loading styles */
        .htmx-request { opacity: 0.8; }
        .htmx-swapping { opacity: 0.3; }
        .htmx-settling { opacity: 1; }
        
        /* Skip link for accessibility */
        .skip-link {
            position: absolute;
            left: -10000px;
            top: auto;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }
        
        .skip-link:focus {
            position: absolute;
            left: 6px;
            top: 7px;
            width: auto;
            height: auto;
            overflow: visible;
            z-index: 999999;
            padding: 8px 16px;
            background: #000;
            color: #fff;
            text-decoration: none;
            border-radius: 4px;
        }
        
        /* Security indicator */
        .security-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            background: #10b981;
            border-radius: 50%;
            z-index: 1000;
            opacity: 0.7;
        }
        
        /* Anti-clickjacking overlay detection */
        .clickjack-detector {
            position: fixed;
            top: 0;
            left: 0;
            width: 1px;
            height: 1px;
            pointer-events: none;
            z-index: -1;
        }
    </style>
    
    {% block extra_head %}{% endblock %}
</head>

<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">
    <!-- Skip Navigation Link -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- Security Indicator (visible in development) -->
    {% if config.DEBUG %}
    <div class="security-indicator" title="Security features active"></div>
    {% endif %}
    
    <!-- Anti-clickjacking detector -->
    <div class="clickjack-detector"></div>
    
    <!-- CSRF Token for JavaScript -->
    <div id="csrf-data" style="display: none;" data-token="{{ csrf_token() }}"></div>
    
    <!-- Security Event Container (for logging) -->
    <div id="security-events" style="display: none;"></div>
    
    <!-- Main Navigation -->
    {% block navigation %}
    <nav class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700" role="navigation" aria-label="Main navigation">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="/" class="flex items-center space-x-2 text-primary hover:text-primary-600">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        <span class="text-xl font-bold">Pynomaly</span>
                    </a>
                </div>
                
                <div class="flex items-center space-x-4">
                    <!-- Theme Toggle -->
                    <button 
                        type="button"
                        class="p-2 rounded-md text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-100"
                        onclick="toggleTheme()"
                        aria-label="Toggle dark mode"
                    >
                        <svg class="w-5 h-5 hidden dark:block" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd" />
                        </svg>
                        <svg class="w-5 h-5 block dark:hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
                        </svg>
                    </button>
                    
                    {% block nav_items %}{% endblock %}
                </div>
            </div>
        </div>
    </nav>
    {% endblock %}
    
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            {% for category, message in messages %}
            <div class="mb-4 p-4 rounded-md {% if category == 'error' %}bg-red-50 border border-red-200 text-red-800{% elif category == 'warning' %}bg-yellow-50 border border-yellow-200 text-yellow-800{% elif category == 'success' %}bg-green-50 border border-green-200 text-green-800{% else %}bg-blue-50 border border-blue-200 text-blue-800{% endif %}" role="alert">
                {{ message }}
                <button type="button" class="float-right ml-2 text-lg leading-none" onclick="this.parentElement.remove()" aria-label="Close message">&times;</button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    {% endwith %}
    
    <!-- Main Content -->
    <main id="main-content" role="main" class="flex-1">
        {% block content %}{% endblock %}
    </main>
    
    <!-- Footer -->
    {% block footer %}
    <footer class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 mt-auto" role="contentinfo">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="text-center text-sm text-gray-500 dark:text-gray-400">
                <p>&copy; 2024 Pynomaly. Advanced Anomaly Detection Platform.</p>
                <p class="mt-2">
                    <a href="/privacy" class="hover:text-gray-700 dark:hover:text-gray-300">Privacy Policy</a> |
                    <a href="/terms" class="hover:text-gray-700 dark:hover:text-gray-300">Terms of Service</a> |
                    <a href="/security" class="hover:text-gray-700 dark:hover:text-gray-300">Security</a>
                </p>
            </div>
        </div>
    </footer>
    {% endblock %}
    
    <!-- Theme Toggle Function -->
    <script nonce="{{ csp_nonce() }}">
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            document.documentElement.classList.toggle('dark', newTheme === 'dark');
            localStorage.setItem('theme', newTheme);
            
            // Dispatch theme change event
            window.dispatchEvent(new CustomEvent('themechange', { 
                detail: { theme: newTheme } 
            }));
        }
    </script>
    
    {% block extra_scripts %}{% endblock %}
</body>
</html>