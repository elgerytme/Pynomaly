<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pynomaly Business Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-900">
                        <i class="fas fa-chart-line text-blue-600 mr-2"></i>
                        Pynomaly Business Dashboard
                    </h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-500">
                        Tenant: <span class="font-medium">{{ tenant_name }}</span>
                    </div>
                    <div class="text-sm text-gray-500">
                        Last Updated: <span id="last-updated">{{ last_updated }}</span>
                    </div>
                    <button 
                        onclick="refreshDashboard()"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm"
                    >
                        <i class="fas fa-sync-alt mr-1"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        
        <!-- Key Metrics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Detection Success Rate -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-600">Detection Success Rate</p>
                        <p class="text-2xl font-bold text-green-600" id="success-rate">{{ success_rate }}%</p>
                        <p class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-arrow-up text-green-500"></i> +2.1% from last month
                        </p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-check-circle text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- Monthly Cost Savings -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-600">Monthly Cost Savings</p>
                        <p class="text-2xl font-bold text-blue-600" id="cost-savings">${{ cost_savings }}</p>
                        <p class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-arrow-up text-green-500"></i> +15.3% from last month
                        </p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-dollar-sign text-blue-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- Total Detections -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-600">Total Detections</p>
                        <p class="text-2xl font-bold text-purple-600" id="total-detections">{{ total_detections }}</p>
                        <p class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-arrow-up text-green-500"></i> +8.7% from last month
                        </p>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-search text-purple-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- Anomalies Found -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-600">Anomalies Found</p>
                        <p class="text-2xl font-bold text-red-600" id="anomalies-found">{{ anomalies_found }}</p>
                        <p class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-arrow-down text-red-500"></i> -3.2% from last month
                        </p>
                    </div>
                    <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Detection Trends Chart -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Detection Trends</h3>
                    <select class="text-sm border-gray-300 rounded" onchange="updateChartPeriod('detection-trends', this.value)">
                        <option value="7d">Last 7 days</option>
                        <option value="30d" selected>Last 30 days</option>
                        <option value="90d">Last 90 days</option>
                    </select>
                </div>
                <canvas id="detection-trends-chart" height="300"></canvas>
            </div>

            <!-- Performance Metrics -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Model Performance</h3>
                    <button class="text-sm text-blue-600 hover:text-blue-800">View Details</button>
                </div>
                <canvas id="performance-chart" height="300"></canvas>
            </div>
        </div>

        <!-- Usage Analytics -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- API Usage -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">API Usage</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Today</span>
                        <span class="font-semibold" id="api-today">{{ api_calls_today }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">This Month</span>
                        <span class="font-semibold" id="api-month">{{ api_calls_month }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Rate Limit</span>
                        <span class="text-sm text-gray-500">{{ api_rate_limit }}/min</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full" style="width: {{ api_usage_percent }}%"></div>
                    </div>
                </div>
            </div>

            <!-- Storage Usage -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Storage Usage</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Used</span>
                        <span class="font-semibold" id="storage-used">{{ storage_used_gb }} GB</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Limit</span>
                        <span class="text-sm text-gray-500">{{ storage_limit_gb }} GB</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-green-600 h-2 rounded-full" style="width: {{ storage_usage_percent }}%"></div>
                    </div>
                    <div class="text-xs text-gray-500">
                        {{ storage_remaining_gb }} GB remaining
                    </div>
                </div>
            </div>

            <!-- Active Users -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">User Activity</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Active Users</span>
                        <span class="font-semibold" id="active-users">{{ active_users }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Total Users</span>
                        <span class="text-sm text-gray-500">{{ total_users }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Sessions Today</span>
                        <span class="font-semibold">{{ sessions_today }}</span>
                    </div>
                    <div class="text-xs text-gray-500">
                        Peak: {{ peak_concurrent_users }} concurrent users
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Alerts -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">Recent Alerts</h3>
                    <button 
                        onclick="checkAlerts()"
                        class="text-sm text-blue-600 hover:text-blue-800"
                    >
                        <i class="fas fa-sync-alt mr-1"></i> Check Now
                    </button>
                </div>
            </div>
            <div class="px-6 py-4">
                <div id="alerts-container">
                    {% if alerts %}
                        {% for alert in alerts %}
                        <div class="flex items-center p-3 border-l-4 border-{{ alert.severity }}-500 bg-{{ alert.severity }}-50 rounded mb-3">
                            <div class="flex-1">
                                <div class="flex items-center">
                                    <i class="fas fa-{{ alert.icon }} text-{{ alert.severity }}-600 mr-2"></i>
                                    <span class="font-medium text-{{ alert.severity }}-800">{{ alert.title }}</span>
                                    <span class="ml-2 text-xs text-gray-500">{{ alert.time_ago }}</span>
                                </div>
                                <p class="text-sm text-{{ alert.severity }}-700 mt-1">{{ alert.message }}</p>
                            </div>
                            <button class="text-{{ alert.severity }}-600 hover:text-{{ alert.severity }}-800">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-check-circle text-green-500 text-3xl mb-2"></i>
                        <p>No active alerts - all systems operating normally</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Chart configurations
        const detectionTrendsChart = new Chart(document.getElementById('detection-trends-chart'), {
            type: 'line',
            data: {
                labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'],
                datasets: [{
                    label: 'Successful Detections',
                    data: [65, 72, 80, 75, 82, 90, 88],
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Failed Detections',
                    data: [5, 3, 2, 4, 1, 2, 3],
                    borderColor: 'rgb(239, 68, 68)',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        const performanceChart = new Chart(document.getElementById('performance-chart'), {
            type: 'radar',
            data: {
                labels: ['Precision', 'Recall', 'F1-Score', 'Accuracy', 'Speed'],
                datasets: [{
                    label: 'Current Model',
                    data: [85, 78, 81, 89, 92],
                    borderColor: 'rgb(16, 185, 129)',
                    backgroundColor: 'rgba(16, 185, 129, 0.2)'
                }, {
                    label: 'Baseline',
                    data: [70, 65, 68, 75, 80],
                    borderColor: 'rgb(156, 163, 175)',
                    backgroundColor: 'rgba(156, 163, 175, 0.2)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });

        // Dashboard functions
        function refreshDashboard() {
            // Simulate data refresh
            document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
            
            // Update metrics via HTMX or fetch API
            fetch('/api/reporting/tenants/{{ tenant_id }}/metrics/realtime?metric_ids=success_rate,cost_savings,total_detections,anomalies_found')
                .then(response => response.json())
                .then(data => {
                    if (data.metrics) {
                        if (data.metrics.success_rate) {
                            document.getElementById('success-rate').textContent = data.metrics.success_rate.formatted_value;
                        }
                        if (data.metrics.cost_savings) {
                            document.getElementById('cost-savings').textContent = data.metrics.cost_savings.formatted_value;
                        }
                        if (data.metrics.total_detections) {
                            document.getElementById('total-detections').textContent = data.metrics.total_detections.formatted_value;
                        }
                        if (data.metrics.anomalies_found) {
                            document.getElementById('anomalies-found').textContent = data.metrics.anomalies_found.formatted_value;
                        }
                    }
                })
                .catch(error => console.error('Error refreshing metrics:', error));
        }

        function updateChartPeriod(chartId, period) {
            // Update chart data based on selected period
            console.log(`Updating ${chartId} for period: ${period}`);
            // Implementation would fetch new data and update chart
        }

        function checkAlerts() {
            fetch('/api/reporting/tenants/{{ tenant_id }}/alerts/check')
                .then(response => response.json())
                .then(data => {
                    const alertsContainer = document.getElementById('alerts-container');
                    if (data.triggered_alerts && data.triggered_alerts.length > 0) {
                        // Update alerts display
                        console.log('Triggered alerts:', data.triggered_alerts);
                    } else {
                        alertsContainer.innerHTML = `
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-check-circle text-green-500 text-3xl mb-2"></i>
                                <p>No active alerts - all systems operating normally</p>
                            </div>
                        `;
                    }
                })
                .catch(error => console.error('Error checking alerts:', error));
        }

        // Auto-refresh every 5 minutes
        setInterval(refreshDashboard, 5 * 60 * 1000);

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            refreshDashboard();
        });
    </script>
</body>
</html>
