<!-- Enhanced Mobile Navigation System -->
<!-- Issue #18: Mobile-Responsive UI Enhancements -->

<!-- Mobile Navigation Header -->
<div class="mobile-nav-header lg:hidden">
  <div class="flex items-center justify-between p-4 bg-white border-b border-gray-200">
    <!-- Mobile Menu Toggle Button -->
    <button
      id="mobile-menu-toggle"
      class="mobile-nav-toggle"
      type="button"
      aria-label="Toggle mobile menu"
      aria-expanded="false"
      aria-controls="mobile-navigation"
    >
      <svg class="mobile-menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
      <svg class="mobile-close-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <!-- Logo/Brand -->
    <div class="flex-1 flex justify-center">
      <a href="/" class="flex items-center space-x-2">
        <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
          <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
          </svg>
        </div>
        <span class="text-lg font-bold text-gray-900">Pynomaly</span>
      </a>
    </div>

    <!-- Mobile Actions -->
    <div class="flex items-center space-x-2">
      <!-- Notifications Button -->
      <button
        class="mobile-touch-target p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors"
        aria-label="Notifications"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-2.405-2.405A3.001 3.001 0 0116 12V8a6 6 0 00-8.5-5.5L5 5C5 2.791 6.791 1 9 1s4 1.791 4 4v3a3 3 0 00-1.405 2.595L9 17h6z"/>
        </svg>
        <span class="sr-only">View notifications</span>
      </button>

      <!-- Search Button -->
      <button
        class="mobile-touch-target p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors"
        aria-label="Search"
        onclick="openMobileSearch()"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
        <span class="sr-only">Search</span>
      </button>
    </div>
  </div>
</div>

<!-- Mobile Sidebar Overlay -->
<div id="mobile-sidebar-overlay" class="mobile-sidebar-overlay lg:hidden" onclick="closeMobileMenu()"></div>

<!-- Enhanced Mobile Sidebar -->
<nav id="mobile-navigation" class="mobile-sidebar lg:hidden" role="navigation" aria-label="Mobile navigation">
  <div class="flex flex-col h-full">
    <!-- Sidebar Header -->
    <div class="flex items-center justify-between p-4 border-b border-gray-200">
      <div class="flex items-center space-x-3">
        <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
          <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
          </svg>
        </div>
        <div>
          <h2 class="text-lg font-semibold text-gray-900">Pynomaly</h2>
          <p class="text-sm text-gray-500">Anomaly Detection</p>
        </div>
      </div>
      <button
        onclick="closeMobileMenu()"
        class="mobile-touch-target p-2 text-gray-500 hover:text-gray-700 rounded-lg"
        aria-label="Close mobile menu"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <!-- Navigation Content -->
    <div class="flex-1 overflow-y-auto py-4">
      <!-- Primary Navigation -->
      <div class="px-4 space-y-1">
        <h3 class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">Main</h3>
        
        {% include 'partials/accessible_mobile_nav.html' %}
      </div>

      <!-- Secondary Navigation -->
      <div class="px-4 mt-8 space-y-1">
        <h3 class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">Tools</h3>
        
        <a
          href="/settings"
          class="mobile-nav-item group flex items-center px-3 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 rounded-lg transition-colors"
          role="menuitem"
        >
          <svg class="mr-3 h-5 w-5 text-gray-400 group-hover:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          Settings
        </a>

        <a
          href="/help"
          class="mobile-nav-item group flex items-center px-3 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 rounded-lg transition-colors"
          role="menuitem"
        >
          <svg class="mr-3 h-5 w-5 text-gray-400 group-hover:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          Help & Support
        </a>
      </div>
    </div>

    <!-- Sidebar Footer -->
    <div class="p-4 border-t border-gray-200">
      {% if current_user %}
      <div class="flex items-center space-x-3 p-2">
        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
          <span class="text-sm font-medium text-blue-600">{{ current_user.name[0] if current_user.name else 'U' }}</span>
        </div>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-medium text-gray-900 truncate">{{ current_user.name or 'User' }}</p>
          <p class="text-xs text-gray-500 truncate">{{ current_user.email or 'user@example.com' }}</p>
        </div>
        <button
          onclick="showUserMenu()"
          class="mobile-touch-target p-1 text-gray-400 hover:text-gray-600 rounded-lg"
          aria-label="User menu"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
          </svg>
        </button>
      </div>
      {% else %}
      <div class="space-y-2">
        <a
          href="/login"
          class="w-full flex justify-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors"
        >
          Sign In
        </a>
        <a
          href="/register"
          class="w-full flex justify-center px-4 py-2 border border-transparent rounded-lg text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition-colors"
        >
          Sign Up
        </a>
      </div>
      {% endif %}
    </div>
  </div>
</nav>

<!-- Mobile Search Overlay -->
<div id="mobile-search-overlay" class="hidden fixed inset-0 z-50 lg:hidden">
  <div class="fixed inset-0 bg-black bg-opacity-50" onclick="closeMobileSearch()"></div>
  <div class="fixed top-0 inset-x-0 p-4">
    <div class="bg-white rounded-lg shadow-lg">
      <div class="flex items-center p-4">
        <div class="flex-1">
          <input
            id="mobile-search-input"
            type="text"
            placeholder="Search detectors, datasets, results..."
            class="w-full px-4 py-2 text-lg border-0 focus:ring-0 focus:outline-none"
            autocomplete="off"
          />
        </div>
        <button
          onclick="closeMobileSearch()"
          class="ml-4 p-2 text-gray-400 hover:text-gray-600 rounded-lg"
          aria-label="Close search"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      
      <!-- Search Results -->
      <div id="mobile-search-results" class="px-4 pb-4">
        <div class="text-sm text-gray-500">Start typing to search...</div>
      </div>
    </div>
  </div>
</div>

<!-- Mobile Navigation JavaScript -->
<script>
// Mobile menu state management
let mobileMenuOpen = false;
let mobileSearchOpen = false;

// Toggle mobile menu
function toggleMobileMenu() {
  mobileMenuOpen = !mobileMenuOpen;
  updateMobileMenuState();
}

// Open mobile menu
function openMobileMenu() {
  mobileMenuOpen = true;
  updateMobileMenuState();
}

// Close mobile menu
function closeMobileMenu() {
  mobileMenuOpen = false;
  updateMobileMenuState();
}

// Update mobile menu state
function updateMobileMenuState() {
  const toggle = document.getElementById('mobile-menu-toggle');
  const overlay = document.getElementById('mobile-sidebar-overlay');
  const sidebar = document.getElementById('mobile-navigation');
  const menuIcon = toggle.querySelector('.mobile-menu-icon');
  const closeIcon = toggle.querySelector('.mobile-close-icon');
  
  if (mobileMenuOpen) {
    overlay.classList.add('open');
    sidebar.classList.add('open');
    toggle.setAttribute('aria-expanded', 'true');
    menuIcon.classList.add('hidden');
    closeIcon.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  } else {
    overlay.classList.remove('open');
    sidebar.classList.remove('open');
    toggle.setAttribute('aria-expanded', 'false');
    menuIcon.classList.remove('hidden');
    closeIcon.classList.add('hidden');
    document.body.style.overflow = '';
  }
}

// Open mobile search
function openMobileSearch() {
  mobileSearchOpen = true;
  const overlay = document.getElementById('mobile-search-overlay');
  const input = document.getElementById('mobile-search-input');
  
  overlay.classList.remove('hidden');
  setTimeout(() => {
    input.focus();
  }, 100);
  document.body.style.overflow = 'hidden';
}

// Close mobile search
function closeMobileSearch() {
  mobileSearchOpen = false;
  const overlay = document.getElementById('mobile-search-overlay');
  
  overlay.classList.add('hidden');
  document.body.style.overflow = '';
}

// Handle mobile menu toggle click
document.addEventListener('DOMContentLoaded', function() {
  const toggle = document.getElementById('mobile-menu-toggle');
  if (toggle) {
    toggle.addEventListener('click', toggleMobileMenu);
  }

  // Handle search input
  const searchInput = document.getElementById('mobile-search-input');
  if (searchInput) {
    searchInput.addEventListener('input', function(e) {
      const query = e.target.value.trim();
      if (query.length > 0) {
        performMobileSearch(query);
      } else {
        clearMobileSearchResults();
      }
    });
  }

  // Handle escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      if (mobileMenuOpen) {
        closeMobileMenu();
      }
      if (mobileSearchOpen) {
        closeMobileSearch();
      }
    }
  });

  // Handle window resize
  window.addEventListener('resize', function() {
    if (window.innerWidth >= 1024) {
      closeMobileMenu();
      closeMobileSearch();
    }
  });
});

// Perform mobile search
function performMobileSearch(query) {
  const resultsContainer = document.getElementById('mobile-search-results');
  resultsContainer.innerHTML = '<div class="text-sm text-gray-500">Searching...</div>';
  
  // Simulate search API call
  setTimeout(() => {
    const mockResults = [
      { type: 'detector', name: 'Isolation Forest', url: '/detectors/isolation-forest' },
      { type: 'dataset', name: 'Sales Data 2024', url: '/datasets/sales-2024' },
      { type: 'result', name: 'Recent Detection Run', url: '/detection/results/123' }
    ].filter(item => item.name.toLowerCase().includes(query.toLowerCase()));

    if (mockResults.length > 0) {
      resultsContainer.innerHTML = mockResults.map(result => `
        <a href="${result.url}" class="block p-3 hover:bg-gray-50 rounded-lg border-b border-gray-100 last:border-b-0">
          <div class="flex items-center space-x-3">
            <div class="flex-shrink-0">
              <span class="inline-block w-2 h-2 rounded-full ${result.type === 'detector' ? 'bg-blue-500' : result.type === 'dataset' ? 'bg-green-500' : 'bg-orange-500'}"></span>
            </div>
            <div class="flex-1">
              <p class="text-sm font-medium text-gray-900">${result.name}</p>
              <p class="text-xs text-gray-500 capitalize">${result.type}</p>
            </div>
          </div>
        </a>
      `).join('');
    } else {
      resultsContainer.innerHTML = '<div class="text-sm text-gray-500">No results found</div>';
    }
  }, 300);
}

// Clear mobile search results
function clearMobileSearchResults() {
  const resultsContainer = document.getElementById('mobile-search-results');
  resultsContainer.innerHTML = '<div class="text-sm text-gray-500">Start typing to search...</div>';
}

// Show user menu (placeholder)
function showUserMenu() {
  // TODO: Implement user menu functionality
  console.log('User menu clicked');
}
</script>

<style>
/* Additional mobile navigation styles */
.mobile-nav-item {
  transition: all 0.2s ease;
}

.mobile-nav-item:hover {
  transform: translateX(4px);
}

.mobile-nav-item.active {
  background-color: #dbeafe;
  color: #1d4ed8;
  border-left: 4px solid #3b82f6;
}

.mobile-nav-item.active svg {
  color: #3b82f6;
}

/* Smooth transitions for overlays */
.mobile-sidebar-overlay {
  transition: opacity 0.3s ease, visibility 0.3s ease;
}

.mobile-sidebar {
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Search overlay animations */
#mobile-search-overlay {
  animation: fadeIn 0.2s ease-out;
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}
</style>