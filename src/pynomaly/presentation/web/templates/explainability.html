{% extends "base.html" %}
{% block title %}Explainability - Pynomaly{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <!-- Header -->
    <div class="mb-8 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">üîç Explainability</h1>
            <p class="mt-2 text-gray-600">Understand and explain anomaly detection results</p>
        </div>
        <div class="flex space-x-3">
            <button onclick="showShapExplanation()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                <svg class="-ml-1 mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                SHAP Analysis
            </button>
            <button onclick="showLimeExplanation()" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                <svg class="-ml-1 mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                LIME Analysis
            </button>
        </div>
    </div>

    <!-- Quick Analysis Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white overflow-hidden shadow rounded-lg hover:shadow-lg transition-shadow cursor-pointer" onclick="showGlobalExplanation()">
            <div class="p-6 text-center">
                <div class="text-4xl mb-3">üåê</div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Global Explanation</h3>
                <p class="text-sm text-gray-600">Model-wide feature importance</p>
            </div>
        </div>
        
        <div class="bg-white overflow-hidden shadow rounded-lg hover:shadow-lg transition-shadow cursor-pointer" onclick="showLocalExplanation()">
            <div class="p-6 text-center">
                <div class="text-4xl mb-3">üéØ</div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Local Explanation</h3>
                <p class="text-sm text-gray-600">Individual anomaly breakdown</p>
            </div>
        </div>
        
        <div class="bg-white overflow-hidden shadow rounded-lg hover:shadow-lg transition-shadow cursor-pointer" onclick="showCohortAnalysis()">
            <div class="p-6 text-center">
                <div class="text-4xl mb-3">üë•</div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Cohort Analysis</h3>
                <p class="text-sm text-gray-600">Group-based explanations</p>
            </div>
        </div>
    </div>

    <!-- Analysis Setup and Results -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Explanation Setup -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">üìã Analysis Setup</h3>
                <form hx-post="/web/htmx/explainability-analyze" 
                      hx-target="#explanation-result"
                      hx-indicator="#analyze-spinner"
                      class="space-y-4">
                    
                    <div>
                        <label for="detector_selection" class="block text-sm font-medium text-gray-700">Detector</label>
                        <select id="detector_selection" name="detector_id" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm rounded-md">
                            <option value="">Select detector...</option>
                            {% for detector in detectors %}
                            <option value="{{ detector.id }}">{{ detector.name }} ({{ detector.algorithm_name }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label for="result_selection" class="block text-sm font-medium text-gray-700">Detection Result</label>
                        <select id="result_selection" name="result_id" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm rounded-md">
                            <option value="">Select result...</option>
                            {% for result in results %}
                            <option value="{{ result.id }}">{{ result.timestamp.strftime('%Y-%m-%d %H:%M') }} - {{ result.n_anomalies }} anomalies</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label for="explanation_type" class="block text-sm font-medium text-gray-700">Explanation Type</label>
                        <select id="explanation_type" name="explanation_type" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm rounded-md">
                            <option value="shap">SHAP (Feature importance)</option>
                            <option value="lime">LIME (Local interpretable explanations)</option>
                            <option value="global">Global feature importance</option>
                            <option value="local">Local anomaly breakdown</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="num_features" class="block text-sm font-medium text-gray-700">Top Features</label>
                            <input type="number" id="num_features" name="num_features" value="10" min="5" max="50" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm">
                        </div>
                        <div>
                            <label for="num_anomalies" class="block text-sm font-medium text-gray-700">Top Anomalies</label>
                            <input type="number" id="num_anomalies" name="num_anomalies" value="5" min="1" max="20" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm">
                        </div>
                    </div>
                    
                    <div class="flex items-center">
                        <input id="include_interactions" name="include_interactions" type="checkbox" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                        <label for="include_interactions" class="ml-2 block text-sm text-gray-900">
                            Include feature interactions
                        </label>
                    </div>
                    
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        <span id="analyze-spinner" class="htmx-indicator">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span>
                        Generate Explanation
                    </button>
                </form>
            </div>
        </div>

        <!-- Quick Insights -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">üí° Quick Insights</h3>
                <div id="quick-insights" 
                     hx-get="/web/htmx/explainability-insights" 
                     hx-trigger="load"
                     hx-indicator="#insights-loading">
                    <div id="insights-loading" class="flex justify-center items-center py-8">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Loading insights...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Explanation Results -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">üìä Explanation Results</h3>
            <div id="explanation-result" class="min-h-96">
                <div class="text-center py-12 text-gray-500">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No explanations generated</h3>
                    <p class="mt-1 text-sm text-gray-500">Select a detector and result to generate explanations.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Feature Importance Visualization -->
    <div class="mt-8 bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">üìà Feature Importance Visualization</h3>
            <div id="feature-importance-chart" class="h-96">
                <!-- D3.js visualization will be inserted here -->
            </div>
        </div>
    </div>

    <!-- SHAP Summary Plot -->
    <div class="mt-8 bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">üéØ SHAP Summary Plot</h3>
            <div id="shap-summary-plot" class="h-96">
                <!-- SHAP visualization will be inserted here -->
            </div>
        </div>
    </div>
</div>

<script>
// Explainability-specific JavaScript functions
function showShapExplanation() {
    document.getElementById('explanation_type').value = 'shap';
    showNotification('SHAP explanation selected. Configure parameters and click "Generate Explanation".', 'info');
}

function showLimeExplanation() {
    document.getElementById('explanation_type').value = 'lime';
    showNotification('LIME explanation selected. Configure parameters and click "Generate Explanation".', 'info');
}

function showGlobalExplanation() {
    document.getElementById('explanation_type').value = 'global';
    showNotification('Global explanation selected. This will show overall feature importance.', 'info');
}

function showLocalExplanation() {
    document.getElementById('explanation_type').value = 'local';
    showNotification('Local explanation selected. This will analyze individual anomalies.', 'info');
}

function showCohortAnalysis() {
    alert('Cohort analysis feature coming soon! This will group similar anomalies and explain common patterns.');
}

function showNotification(message, type = 'info') {
    const colors = {
        info: 'bg-blue-50 border-blue-200 text-blue-800',
        success: 'bg-green-50 border-green-200 text-green-800',
        warning: 'bg-yellow-50 border-yellow-200 text-yellow-800',
        error: 'bg-red-50 border-red-200 text-red-800'
    };
    
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 border rounded-lg ${colors[type]} z-50`;
    notification.innerHTML = `
        <div class="flex items-center">
            <p class="text-sm font-medium">${message}</p>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-sm underline">Dismiss</button>
        </div>
    `;
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}

// Feature importance chart using D3.js
function createFeatureImportanceChart(data) {
    const margin = {top: 20, right: 30, bottom: 40, left: 120};
    const width = 800 - margin.left - margin.right;
    const height = 400 - margin.top - margin.bottom;

    // Clear existing chart
    d3.select("#feature-importance-chart").selectAll("*").remove();

    const svg = d3.select("#feature-importance-chart")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

    // Scales
    const x = d3.scaleLinear()
        .domain([0, d3.max(data, d => d.importance)])
        .range([0, width]);

    const y = d3.scaleBand()
        .domain(data.map(d => d.feature))
        .range([0, height])
        .padding(0.1);

    // Bars
    svg.selectAll(".bar")
        .data(data)
        .enter().append("rect")
        .attr("class", "bar")
        .attr("y", d => y(d.feature))
        .attr("height", y.bandwidth())
        .attr("x", 0)
        .attr("width", d => x(d.importance))
        .attr("fill", "#3B82F6");

    // Axes
    svg.append("g")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x));

    svg.append("g")
        .call(d3.axisLeft(y));

    // Labels
    svg.append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 0 - margin.left)
        .attr("x", 0 - (height / 2))
        .attr("dy", "1em")
        .style("text-anchor", "middle")
        .text("Features");

    svg.append("text")
        .attr("transform", `translate(${width / 2}, ${height + margin.bottom})`)
        .style("text-anchor", "middle")
        .text("Importance Score");
}

// SHAP summary plot placeholder
function createShapSummaryPlot(data) {
    const container = d3.select("#shap-summary-plot");
    container.selectAll("*").remove();
    
    container.append("div")
        .attr("class", "flex items-center justify-center h-full text-gray-500")
        .html(`
            <div class="text-center">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">SHAP Summary Plot</h3>
                <p class="mt-1 text-sm text-gray-500">Generate SHAP explanations to see the summary plot.</p>
            </div>
        `);
}

// Initialize empty charts
document.addEventListener('DOMContentLoaded', function() {
    createFeatureImportanceChart([]);
    createShapSummaryPlot([]);
});
</script>
{% endblock %}