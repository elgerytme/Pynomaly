{% extends "base.html" %} {% block title %}Anomaly Detection{% endblock %} {%
block content %}
<div class="max-w-6xl mx-auto px-4 py-8">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-3xl font-bold text-gray-900">Anomaly Detection</h1>
      <p class="text-gray-600 mt-1">
        Train detectors and run anomaly detection
      </p>
    </div>
  </div>

  <!-- Detection Workflow -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <!-- Training Section -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">ğŸ¯ Train Detector</h3>
      </div>
      <div class="card-content">
        <form
          hx-post="/web/htmx/train-detector"
          hx-target="#training-result"
          hx-indicator="#training-spinner"
        >
          <div class="space-y-4">
            <div>
              <label
                for="train-detector"
                class="block text-sm font-medium text-gray-700 mb-1"
              >
                Select Detector
              </label>
              <select
                id="train-detector"
                name="detector_id"
                required
                class="select w-full"
              >
                <option value="">Choose a detector...</option>
                {% for detector in detectors %}
                <option value="{{ detector.id }}">
                  {{ detector.name }} ({{ detector.algorithm }}) {% if
                  detector.is_fitted %}âœ“ Trained{% endif %}
                </option>
                {% endfor %}
              </select>
            </div>

            <div>
              <label
                for="train-dataset"
                class="block text-sm font-medium text-gray-700 mb-1"
              >
                Training Dataset
              </label>
              <select
                id="train-dataset"
                name="dataset_id"
                required
                class="select w-full"
              >
                <option value="">Choose a dataset...</option>
                {% for dataset in datasets %}
                <option value="{{ dataset.id }}">
                  {{ dataset.name }} ({{ dataset.data.shape[0] }} rows)
                </option>
                {% endfor %}
              </select>
            </div>

            <button type="submit" class="btn btn-primary w-full">
              <span
                id="training-spinner"
                class="htmx-indicator spinner-sm mr-2"
              ></span>
              Train Detector
            </button>
          </div>
        </form>

        <div id="training-result" class="mt-4">
          <!-- Training results will appear here -->
        </div>
      </div>
    </div>

    <!-- Detection Section -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">ğŸ” Run Detection</h3>
      </div>
      <div class="card-content">
        <form
          hx-post="/web/htmx/detect-anomalies"
          hx-target="#detection-result"
          hx-indicator="#detection-spinner"
        >
          <div class="space-y-4">
            <div>
              <label
                for="detect-detector"
                class="block text-sm font-medium text-gray-700 mb-1"
              >
                Trained Detector
              </label>
              <select
                id="detect-detector"
                name="detector_id"
                required
                class="select w-full"
              >
                <option value="">Choose a trained detector...</option>
                {% for detector in trained_detectors %}
                <option value="{{ detector.id }}">
                  {{ detector.name }} ({{ detector.algorithm }})
                </option>
                {% endfor %}
              </select>
              {% if not trained_detectors %}
              <p class="text-sm text-orange-600 mt-1">
                No trained detectors available. Train a detector first.
              </p>
              {% endif %}
            </div>

            <div>
              <label
                for="detect-dataset"
                class="block text-sm font-medium text-gray-700 mb-1"
              >
                Detection Dataset
              </label>
              <select
                id="detect-dataset"
                name="dataset_id"
                required
                class="select w-full"
              >
                <option value="">Choose a dataset...</option>
                {% for dataset in datasets %}
                <option value="{{ dataset.id }}">
                  {{ dataset.name }} ({{ dataset.data.shape[0] }} rows)
                </option>
                {% endfor %}
              </select>
            </div>

            <button
              type="submit"
              class="btn btn-primary w-full"
              {%
              if
              not
              trained_detectors
              %}disabled{%
              endif
              %}
            >
              <span
                id="detection-spinner"
                class="htmx-indicator spinner-sm mr-2"
              ></span>
              Detect Anomalies
            </button>
          </div>
        </form>

        <div id="detection-result" class="mt-4">
          <!-- Detection results will appear here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Results -->
  <div class="card">
    <div class="card-header flex justify-between items-center">
      <h3 class="card-title">ğŸ“Š Recent Detection Results</h3>
      <button
        hx-get="/web/htmx/results-table"
        hx-target="#results-table"
        class="btn btn-outline btn-sm"
      >
        ğŸ”„ Refresh
      </button>
    </div>
    <div class="card-content">
      <div
        id="results-table"
        hx-get="/web/htmx/results-table"
        hx-trigger="load, every 30s"
      >
        <!-- Results loaded via HTMX -->
        <div class="text-center py-8">
          <div class="spinner"></div>
          <p class="text-gray-600 mt-2">Loading results...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Stats -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
    <div class="metric-card">
      <div class="metric-icon bg-blue-100 text-blue-600">ğŸ¤–</div>
      <div>
        <div class="metric-label">Total Detectors</div>
        <div class="metric-value">{{ detectors|length }}</div>
      </div>
    </div>

    <div class="metric-card">
      <div class="metric-icon bg-green-100 text-green-600">âœ…</div>
      <div>
        <div class="metric-label">Trained Detectors</div>
        <div class="metric-value">{{ trained_detectors|length }}</div>
      </div>
    </div>

    <div class="metric-card">
      <div class="metric-icon bg-purple-100 text-purple-600">ğŸ“Š</div>
      <div>
        <div class="metric-label">Available Datasets</div>
        <div class="metric-value">{{ datasets|length }}</div>
      </div>
    </div>
  </div>

  <!-- Help Section -->
  <div class="mt-8 p-6 bg-blue-50 rounded-lg">
    <h4 class="text-lg font-semibold text-blue-900 mb-2">Getting Started</h4>
    <div class="text-blue-800 space-y-2">
      <p>
        <strong>1. Train a Detector:</strong> Select an untrained detector and a
        dataset to train it on.
      </p>
      <p>
        <strong>2. Run Detection:</strong> Use a trained detector to find
        anomalies in your data.
      </p>
      <p>
        <strong>3. View Results:</strong> Check the results table to see
        detected anomalies and statistics.
      </p>
    </div>
  </div>
</div>
{% endblock %}
