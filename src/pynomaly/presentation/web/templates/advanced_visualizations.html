{% extends "base.html" %}

{% block title %}Advanced Visualizations - Pynomaly{% endblock %}

{% block head %}
<style>
    .chart-container {
        position: relative;
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .chart-container:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .chart-header {
        padding: 16px;
        border-bottom: 1px solid #E5E7EB;
        display: flex;
        justify-content: between;
        align-items: center;
    }
    .chart-content {
        padding: 16px;
        min-height: 300px;
    }
    .filter-panel {
        background: #F9FAFB;
        border: 1px solid #E5E7EB;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 20px;
    }
    .interactive-legend {
        cursor: pointer;
        transition: opacity 0.2s ease;
    }
    .interactive-legend:hover {
        opacity: 0.7;
    }
    .chart-annotation {
        position: absolute;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 12px;
        pointer-events: none;
        z-index: 1000;
        max-width: 200px;
    }
    .brush-selection {
        fill: rgba(59, 130, 246, 0.2);
        stroke: #3B82F6;
        stroke-width: 1;
    }
    .zoom-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        flex-direction: column;
        gap: 5px;
        z-index: 100;
    }
    .zoom-btn {
        width: 30px;
        height: 30px;
        background: white;
        border: 1px solid #D1D5DB;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s;
    }
    .zoom-btn:hover {
        background: #F3F4F6;
    }
    .anomaly-heatmap {
        cursor: crosshair;
    }
    .timeline-scrubber {
        background: #E5E7EB;
        height: 20px;
        border-radius: 10px;
        position: relative;
        margin: 10px 0;
        cursor: pointer;
    }
    .timeline-handle {
        position: absolute;
        top: -5px;
        width: 30px;
        height: 30px;
        background: #3B82F6;
        border: 2px solid white;
        border-radius: 50%;
        cursor: grab;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .timeline-handle:active {
        cursor: grabbing;
    }
    .comparison-panel {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
    }
    .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    .metric-card::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        animation: shimmer 3s ease-in-out infinite;
    }
    @keyframes shimmer {
        0%, 100% { transform: rotate(0deg); }
        50% { transform: rotate(180deg); }
    }
    .data-table-container {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #E5E7EB;
        border-radius: 8px;
    }
    .interactive-tooltip {
        opacity: 0;
        transition: opacity 0.2s ease;
        pointer-events: none;
    }
    .chart-export-menu {
        position: absolute;
        top: 40px;
        right: 10px;
        background: white;
        border: 1px solid #D1D5DB;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        padding: 8px 0;
        z-index: 200;
        min-width: 120px;
    }
    .export-option {
        padding: 8px 16px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s;
    }
    .export-option:hover {
        background: #F3F4F6;
    }
</style>
{% endblock %}

{% block content %}
<div x-data="advancedVisualizationDashboard()" class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="px-6 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Advanced Visualizations</h1>
                    <p class="text-gray-600 mt-1">Interactive data exploration and anomaly analysis</p>
                </div>
                <div class="flex space-x-4">
                    <button @click="addCustomChart()" 
                            class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Custom Chart
                    </button>
                    <button @click="exportDashboard()" 
                            class="bg-secondary text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fas fa-download mr-2"></i>Export Dashboard
                    </button>
                    <button @click="shareVisualization()" 
                            class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                        <i class="fas fa-share mr-2"></i>Share
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter and Control Panel -->
    <div class="px-6 py-4">
        <div class="filter-panel">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Dataset</label>
                    <select x-model="selectedDataset" @change="updateVisualization()" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        <template x-for="dataset in datasets" :key="dataset.id">
                            <option :value="dataset.id" x-text="dataset.name"></option>
                        </template>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Algorithm</label>
                    <select x-model="selectedAlgorithm" @change="updateVisualization()" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="">All Algorithms</option>
                        <template x-for="algorithm in algorithms" :key="algorithm">
                            <option :value="algorithm" x-text="algorithm"></option>
                        </template>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Time Range</label>
                    <select x-model="timeRange" @change="updateTimeRange()" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="1h">Last Hour</option>
                        <option value="24h">Last 24 Hours</option>
                        <option value="7d">Last 7 Days</option>
                        <option value="30d">Last 30 Days</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Anomaly Threshold</label>
                    <input type="range" x-model="anomalyThreshold" @input="updateThreshold()" 
                           min="0" max="1" step="0.01"
                           class="w-full">
                    <div class="text-sm text-gray-600 mt-1" x-text="`Threshold: ${anomalyThreshold}`"></div>
                </div>
            </div>
            
            <!-- Advanced Filters -->
            <div x-show="showAdvancedFilters" class="mt-4 pt-4 border-t border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Confidence Level</label>
                        <input type="range" x-model="confidenceLevel" min="0.8" max="0.99" step="0.01"
                               class="w-full">
                        <div class="text-sm text-gray-600 mt-1" x-text="`${(confidenceLevel * 100).toFixed(0)}%`"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Contamination Rate</label>
                        <input type="range" x-model="contaminationRate" min="0.01" max="0.5" step="0.01"
                               class="w-full">
                        <div class="text-sm text-gray-600 mt-1" x-text="`${(contaminationRate * 100).toFixed(1)}%`"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sample Size</label>
                        <input type="range" x-model="sampleSize" min="100" max="10000" step="100"
                               class="w-full">
                        <div class="text-sm text-gray-600 mt-1" x-text="`${sampleSize} samples`"></div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 flex justify-between items-center">
                <button @click="showAdvancedFilters = !showAdvancedFilters" 
                        class="text-primary hover:text-blue-700 text-sm font-medium">
                    <i :class="showAdvancedFilters ? 'fas fa-chevron-up' : 'fas fa-chevron-down'" class="mr-1"></i>
                    Advanced Filters
                </button>
                <div class="flex space-x-2">
                    <button @click="resetFilters()" 
                            class="text-gray-600 hover:text-gray-800 text-sm">
                        Reset
                    </button>
                    <button @click="saveFilterPreset()" 
                            class="text-primary hover:text-blue-700 text-sm">
                        Save Preset
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Grid -->
    <div class="px-6 pb-6">
        <!-- Key Metrics Row -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="metric-card">
                <div class="text-3xl font-bold" x-text="metrics.totalAnomalies"></div>
                <div class="text-sm opacity-90">Total Anomalies</div>
                <div class="text-xs mt-2">
                    <i class="fas fa-arrow-up mr-1"></i>
                    <span x-text="`+${metrics.anomalyGrowth}% from last week`"></span>
                </div>
            </div>
            <div class="metric-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <div class="text-3xl font-bold" x-text="`${(metrics.accuracy * 100).toFixed(1)}%`"></div>
                <div class="text-sm opacity-90">Detection Accuracy</div>
                <div class="text-xs mt-2">
                    <i class="fas fa-arrow-up mr-1"></i>
                    <span x-text="`+${metrics.accuracyImprovement}% improved`"></span>
                </div>
            </div>
            <div class="metric-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <div class="text-3xl font-bold" x-text="`${metrics.processingTime}ms`"></div>
                <div class="text-sm opacity-90">Avg Processing Time</div>
                <div class="text-xs mt-2">
                    <i class="fas fa-arrow-down mr-1"></i>
                    <span x-text="`-${metrics.speedImprovement}% faster`"></span>
                </div>
            </div>
            <div class="metric-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <div class="text-3xl font-bold" x-text="`${(metrics.falsePositiveRate * 100).toFixed(2)}%`"></div>
                <div class="text-sm opacity-90">False Positive Rate</div>
                <div class="text-xs mt-2">
                    <i class="fas fa-arrow-down mr-1"></i>
                    <span x-text="`-${metrics.falsePositiveImprovement}% reduced`"></span>
                </div>
            </div>
        </div>

        <!-- Main Charts Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Real-time Anomaly Detection Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="text-lg font-semibold text-gray-900">Real-time Anomaly Detection</h3>
                    <div class="flex space-x-2">
                        <button @click="toggleRealTime()" 
                                :class="realTimeEnabled ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'"
                                class="px-3 py-1 rounded-full text-xs font-medium">
                            <i :class="realTimeEnabled ? 'fas fa-pause' : 'fas fa-play'" class="mr-1"></i>
                            <span x-text="realTimeEnabled ? 'Live' : 'Paused'"></span>
                        </button>
                        <button @click="showExportMenu('realtime')" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-content">
                    <div id="realtime-chart" class="relative">
                        <div class="zoom-controls">
                            <button class="zoom-btn" @click="zoomIn('realtime')">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="zoom-btn" @click="zoomOut('realtime')">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button class="zoom-btn" @click="resetZoom('realtime')">
                                <i class="fas fa-expand-arrows-alt"></i>
                            </button>
                        </div>
                        <!-- Chart will be rendered here by ECharts -->
                    </div>
                    <div class="timeline-scrubber" @click="seekTimeline($event)">
                        <div class="timeline-handle" 
                             :style="`left: ${timelinePosition}%`"
                             @mousedown="startDragging($event)"></div>
                    </div>
                </div>
            </div>

            <!-- Algorithm Performance Comparison -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="text-lg font-semibold text-gray-900">Algorithm Performance</h3>
                    <div class="flex space-x-2">
                        <select x-model="comparisonMetric" @change="updateComparison()" 
                                class="text-sm border border-gray-300 rounded px-2 py-1">
                            <option value="accuracy">Accuracy</option>
                            <option value="precision">Precision</option>
                            <option value="recall">Recall</option>
                            <option value="f1_score">F1 Score</option>
                            <option value="processing_time">Processing Time</option>
                        </select>
                        <button @click="showExportMenu('comparison')" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-content">
                    <div id="comparison-chart"></div>
                </div>
            </div>
        </div>

        <!-- Secondary Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Feature Importance Radar -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="text-lg font-semibold text-gray-900">Feature Importance</h3>
                    <button @click="showExportMenu('radar')" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
                <div class="chart-content">
                    <div id="radar-chart"></div>
                    <div class="mt-4">
                        <div class="flex flex-wrap gap-2">
                            <template x-for="(feature, index) in topFeatures" :key="index">
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium"
                                      x-text="`${feature.name}: ${(feature.importance * 100).toFixed(1)}%`"></span>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Anomaly Distribution Heatmap -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="text-lg font-semibold text-gray-900">Anomaly Heatmap</h3>
                    <div class="flex space-x-2">
                        <select x-model="heatmapDimension" @change="updateHeatmap()" 
                                class="text-sm border border-gray-300 rounded px-2 py-1">
                            <option value="time_feature">Time vs Feature</option>
                            <option value="feature_feature">Feature vs Feature</option>
                            <option value="geographic">Geographic</option>
                        </select>
                        <button @click="showExportMenu('heatmap')" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-content">
                    <div id="heatmap-chart" class="anomaly-heatmap"></div>
                </div>
            </div>

            <!-- Anomaly Score Distribution -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="text-lg font-semibold text-gray-900">Score Distribution</h3>
                    <button @click="showExportMenu('distribution')" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
                <div class="chart-content">
                    <div id="distribution-chart"></div>
                    <div class="mt-4 text-sm text-gray-600">
                        <div class="flex justify-between">
                            <span>Normal: <span class="font-medium" x-text="`${distributionStats.normal}%`"></span></span>
                            <span>Anomalous: <span class="font-medium" x-text="`${distributionStats.anomalous}%`"></span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Analysis Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Interactive Data Table -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="text-lg font-semibold text-gray-900">Anomaly Details</h3>
                    <div class="flex space-x-2">
                        <input type="text" x-model="tableSearchQuery" @input="filterTable()" 
                               placeholder="Search anomalies..."
                               class="text-sm border border-gray-300 rounded px-2 py-1 w-32">
                        <button @click="exportTable()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-content">
                    <div class="data-table-container">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                        @click="sortTable('timestamp')">
                                        Timestamp
                                        <i :class="getSortIcon('timestamp')" class="ml-1"></i>
                                    </th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                        @click="sortTable('score')">
                                        Score
                                        <i :class="getSortIcon('score')" class="ml-1"></i>
                                    </th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer"
                                        @click="sortTable('algorithm')">
                                        Algorithm
                                        <i :class="getSortIcon('algorithm')" class="ml-1"></i>
                                    </th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                                        Actions
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-for="anomaly in filteredAnomalies" :key="anomaly.id">
                                    <tr class="hover:bg-gray-50 cursor-pointer" @click="showAnomalyDetails(anomaly)">
                                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900" 
                                            x-text="formatDateTime(anomaly.timestamp)"></td>
                                        <td class="px-4 py-2 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <div :class="getScoreColor(anomaly.score)" 
                                                     class="w-2 h-2 rounded-full mr-2"></div>
                                                <span class="text-sm font-medium" x-text="anomaly.score.toFixed(3)"></span>
                                            </div>
                                        </td>
                                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900" 
                                            x-text="anomaly.algorithm"></td>
                                        <td class="px-4 py-2 whitespace-nowrap text-sm">
                                            <button @click.stop="explainAnomaly(anomaly)" 
                                                    class="text-blue-600 hover:text-blue-800 mr-2">
                                                Explain
                                            </button>
                                            <button @click.stop="flagAnomaly(anomaly)" 
                                                    class="text-yellow-600 hover:text-yellow-800">
                                                Flag
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Model Comparison -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="text-lg font-semibold text-gray-900">Model Comparison</h3>
                    <button @click="addModelToComparison()" class="text-primary hover:text-blue-700 text-sm">
                        <i class="fas fa-plus mr-1"></i>Add Model
                    </button>
                </div>
                <div class="chart-content">
                    <div class="comparison-panel">
                        <template x-for="model in comparisonModels" :key="model.id">
                            <div class="border border-gray-200 rounded-lg p-4">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-medium text-gray-900" x-text="model.name"></h4>
                                    <button @click="removeFromComparison(model)" 
                                            class="text-gray-400 hover:text-gray-600">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-600">Accuracy:</span>
                                        <span class="font-medium" x-text="`${(model.accuracy * 100).toFixed(1)}%`"></span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-600">Precision:</span>
                                        <span class="font-medium" x-text="`${(model.precision * 100).toFixed(1)}%`"></span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-600">Recall:</span>
                                        <span class="font-medium" x-text="`${(model.recall * 100).toFixed(1)}%`"></span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-600">Processing:</span>
                                        <span class="font-medium" x-text="`${model.processingTime}ms`"></span>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div :style="`width: ${model.overallScore * 100}%`" 
                                             class="bg-blue-600 h-2 rounded-full"></div>
                                    </div>
                                    <div class="text-xs text-gray-600 mt-1">
                                        Overall Score: <span x-text="`${(model.overallScore * 100).toFixed(1)}%`"></span>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Menu -->
    <div x-show="showExportMenuFor" 
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-75"
         x-transition:leave-start="opacity-100 scale-100"
         x-transition:leave-end="opacity-0 scale-95"
         class="chart-export-menu">
        <div class="export-option" @click="exportChart('png')">
            <i class="fas fa-image mr-2"></i>PNG Image
        </div>
        <div class="export-option" @click="exportChart('svg')">
            <i class="fas fa-vector-square mr-2"></i>SVG Vector
        </div>
        <div class="export-option" @click="exportChart('pdf')">
            <i class="fas fa-file-pdf mr-2"></i>PDF Document
        </div>
        <div class="export-option" @click="exportChart('data')">
            <i class="fas fa-database mr-2"></i>Raw Data (CSV)
        </div>
    </div>

    <!-- Interactive Tooltip -->
    <div id="interactive-tooltip" class="interactive-tooltip chart-annotation"></div>
</div>

<script>
function advancedVisualizationDashboard() {
    return {
        // Filter states
        selectedDataset: 'financial-fraud',
        selectedAlgorithm: '',
        timeRange: '24h',
        anomalyThreshold: 0.5,
        confidenceLevel: 0.95,
        contaminationRate: 0.1,
        sampleSize: 1000,
        showAdvancedFilters: false,
        
        // Chart states
        realTimeEnabled: true,
        timelinePosition: 75,
        comparisonMetric: 'accuracy',
        heatmapDimension: 'time_feature',
        
        // Table states
        tableSearchQuery: '',
        tableSortField: 'timestamp',
        tableSortDirection: 'desc',
        
        // UI states
        showExportMenuFor: null,
        
        // Data
        datasets: [
            { id: 'financial-fraud', name: 'Financial Fraud Detection' },
            { id: 'network-intrusion', name: 'Network Intrusion' },
            { id: 'iot-sensors', name: 'IoT Sensor Data' },
            { id: 'manufacturing', name: 'Manufacturing QC' }
        ],
        
        algorithms: [
            'Isolation Forest',
            'Local Outlier Factor',
            'One-Class SVM',
            'DBSCAN',
            'Autoencoder'
        ],
        
        metrics: {
            totalAnomalies: 1247,
            accuracy: 0.923,
            processingTime: 24,
            falsePositiveRate: 0.032,
            anomalyGrowth: 12,
            accuracyImprovement: 8,
            speedImprovement: 15,
            falsePositiveImprovement: 23
        },
        
        topFeatures: [
            { name: 'transaction_amount', importance: 0.34 },
            { name: 'time_since_last', importance: 0.28 },
            { name: 'merchant_category', importance: 0.22 },
            { name: 'location_risk', importance: 0.16 }
        ],
        
        distributionStats: {
            normal: 91.2,
            anomalous: 8.8
        },
        
        anomalies: [
            {
                id: 1,
                timestamp: new Date(Date.now() - 3600000),
                score: 0.923,
                algorithm: 'Isolation Forest',
                features: { amount: 15000, merchant: 'Unknown' }
            },
            {
                id: 2,
                timestamp: new Date(Date.now() - 7200000),
                score: 0.856,
                algorithm: 'LOF',
                features: { amount: 2500, location: 'Unusual' }
            },
            {
                id: 3,
                timestamp: new Date(Date.now() - 10800000),
                score: 0.741,
                algorithm: 'One-Class SVM',
                features: { pattern: 'Irregular', time: 'Off-hours' }
            }
        ],
        
        comparisonModels: [
            {
                id: 1,
                name: 'Isolation Forest v1.2',
                accuracy: 0.923,
                precision: 0.891,
                recall: 0.856,
                processingTime: 24,
                overallScore: 0.89
            },
            {
                id: 2,
                name: 'LOF Ensemble',
                accuracy: 0.889,
                precision: 0.934,
                recall: 0.823,
                processingTime: 67,
                overallScore: 0.86
            }
        ],
        
        init() {
            this.initializeCharts();
            this.startRealTimeUpdates();
            this.setupEventListeners();
        },
        
        get filteredAnomalies() {
            let filtered = this.anomalies;
            
            if (this.tableSearchQuery) {
                const query = this.tableSearchQuery.toLowerCase();
                filtered = filtered.filter(anomaly => 
                    anomaly.algorithm.toLowerCase().includes(query) ||
                    anomaly.score.toString().includes(query)
                );
            }
            
            // Sort
            filtered.sort((a, b) => {
                const aVal = a[this.tableSortField];
                const bVal = b[this.tableSortField];
                
                if (this.tableSortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            return filtered;
        },
        
        initializeCharts() {
            this.initRealtimeChart();
            this.initComparisonChart();
            this.initRadarChart();
            this.initHeatmapChart();
            this.initDistributionChart();
        },
        
        initRealtimeChart() {
            const chart = echarts.init(document.getElementById('realtime-chart'));
            
            // Generate sample time series data
            const data = [];
            const anomalyData = [];
            const now = new Date();
            
            for (let i = 299; i >= 0; i--) {
                const time = new Date(now.getTime() - i * 60000);
                const value = Math.random() * 100 + Math.sin(i / 10) * 20;
                data.push([time, value]);
                
                // Add some anomalies
                if (Math.random() < 0.05) {
                    anomalyData.push([time, value + Math.random() * 50 + 50]);
                }
            }
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    formatter: (params) => {
                        return `Time: ${params[0].axisValueLabel}<br/>Value: ${params[0].value[1].toFixed(2)}`;
                    }
                },
                legend: {
                    data: ['Normal Data', 'Anomalies']
                },
                xAxis: {
                    type: 'time',
                    splitLine: { show: false }
                },
                yAxis: {
                    type: 'value',
                    splitLine: { show: true }
                },
                dataZoom: [
                    {
                        type: 'inside',
                        xAxisIndex: 0,
                        filterMode: 'none'
                    },
                    {
                        type: 'slider',
                        xAxisIndex: 0,
                        filterMode: 'none'
                    }
                ],
                series: [
                    {
                        name: 'Normal Data',
                        type: 'line',
                        data: data,
                        smooth: true,
                        lineStyle: { color: '#3B82F6' },
                        areaStyle: { color: 'rgba(59, 130, 246, 0.1)' }
                    },
                    {
                        name: 'Anomalies',
                        type: 'scatter',
                        data: anomalyData,
                        symbolSize: 8,
                        itemStyle: { color: '#EF4444' }
                    }
                ]
            };
            
            chart.setOption(option);
            this.realtimeChart = chart;
            
            // Handle window resize
            window.addEventListener('resize', () => chart.resize());
        },
        
        initComparisonChart() {
            const chart = echarts.init(document.getElementById('comparison-chart'));
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' }
                },
                legend: {
                    data: ['Accuracy', 'Precision', 'Recall', 'F1 Score']
                },
                xAxis: {
                    type: 'category',
                    data: ['Isolation Forest', 'LOF', 'One-Class SVM', 'DBSCAN', 'Autoencoder']
                },
                yAxis: {
                    type: 'value',
                    max: 1
                },
                series: [
                    {
                        name: 'Accuracy',
                        type: 'bar',
                        data: [0.923, 0.889, 0.856, 0.834, 0.901],
                        itemStyle: { color: '#3B82F6' }
                    },
                    {
                        name: 'Precision',
                        type: 'bar',
                        data: [0.891, 0.934, 0.823, 0.798, 0.876],
                        itemStyle: { color: '#10B981' }
                    },
                    {
                        name: 'Recall',
                        type: 'bar',
                        data: [0.856, 0.823, 0.789, 0.856, 0.845],
                        itemStyle: { color: '#F59E0B' }
                    },
                    {
                        name: 'F1 Score',
                        type: 'bar',
                        data: [0.873, 0.876, 0.806, 0.826, 0.860],
                        itemStyle: { color: '#EF4444' }
                    }
                ]
            };
            
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        },
        
        initRadarChart() {
            const chart = echarts.init(document.getElementById('radar-chart'));
            
            const option = {
                tooltip: {},
                radar: {
                    indicator: [
                        { name: 'Transaction Amount', max: 100 },
                        { name: 'Time Pattern', max: 100 },
                        { name: 'Location Risk', max: 100 },
                        { name: 'Merchant Category', max: 100 },
                        { name: 'User Behavior', max: 100 },
                        { name: 'Network Features', max: 100 }
                    ]
                },
                series: [{
                    name: 'Feature Importance',
                    type: 'radar',
                    data: [
                        {
                            value: [85, 70, 65, 80, 55, 60],
                            name: 'Current Model',
                            itemStyle: { color: '#3B82F6' },
                            areaStyle: { color: 'rgba(59, 130, 246, 0.3)' }
                        }
                    ]
                }]
            };
            
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        },
        
        initHeatmapChart() {
            const chart = echarts.init(document.getElementById('heatmap-chart'));
            
            // Generate heatmap data
            const data = [];
            for (let i = 0; i < 24; i++) {
                for (let j = 0; j < 7; j++) {
                    data.push([i, j, Math.random() * 100]);
                }
            }
            
            const option = {
                tooltip: {
                    position: 'top',
                    formatter: (params) => {
                        return `Hour: ${params.value[0]}:00<br/>Day: ${['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'][params.value[1]]}<br/>Anomalies: ${params.value[2].toFixed(0)}`;
                    }
                },
                grid: {
                    height: '80%',
                    top: '10%'
                },
                xAxis: {
                    type: 'category',
                    data: Array.from({length: 24}, (_, i) => `${i}:00`),
                    splitArea: { show: true }
                },
                yAxis: {
                    type: 'category',
                    data: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    splitArea: { show: true }
                },
                visualMap: {
                    min: 0,
                    max: 100,
                    calculable: true,
                    orient: 'horizontal',
                    left: 'center',
                    bottom: '5%',
                    inRange: {
                        color: ['#313695', '#4575b4', '#74add1', '#abd9e9', '#e0f3f8', '#fee090', '#fdae61', '#f46d43', '#d73027', '#a50026']
                    }
                },
                series: [{
                    name: 'Anomaly Count',
                    type: 'heatmap',
                    data: data,
                    label: { show: false },
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }]
            };
            
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        },
        
        initDistributionChart() {
            const chart = echarts.init(document.getElementById('distribution-chart'));
            
            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: {c} ({d}%)'
                },
                series: [
                    {
                        name: 'Anomaly Distribution',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        avoidLabelOverlap: false,
                        label: {
                            show: false,
                            position: 'center'
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: '18',
                                fontWeight: 'bold'
                            }
                        },
                        labelLine: { show: false },
                        data: [
                            { value: 91.2, name: 'Normal', itemStyle: { color: '#10B981' } },
                            { value: 8.8, name: 'Anomalous', itemStyle: { color: '#EF4444' } }
                        ]
                    }
                ]
            };
            
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        },
        
        startRealTimeUpdates() {
            setInterval(() => {
                if (this.realTimeEnabled && this.realtimeChart) {
                    this.updateRealtimeChart();
                }
            }, 5000);
        },
        
        updateRealtimeChart() {
            const option = this.realtimeChart.getOption();
            const series = option.series[0];
            const data = series.data;
            
            // Add new data point
            const now = new Date();
            const value = Math.random() * 100 + Math.sin(Date.now() / 10000) * 20;
            data.push([now, value]);
            
            // Keep only last 300 points
            if (data.length > 300) {
                data.shift();
            }
            
            // Update anomalies occasionally
            const anomalySeries = option.series[1];
            if (Math.random() < 0.1) {
                anomalySeries.data.push([now, value + Math.random() * 50 + 50]);
            }
            
            this.realtimeChart.setOption(option);
        },
        
        setupEventListeners() {
            // Click outside to close export menu
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.chart-export-menu') && !e.target.closest('[data-export-trigger]')) {
                    this.showExportMenuFor = null;
                }
            });
        },
        
        // Event handlers
        updateVisualization() {
            // Update all charts based on filters
            console.log('Updating visualizations with filters:', {
                dataset: this.selectedDataset,
                algorithm: this.selectedAlgorithm,
                timeRange: this.timeRange
            });
        },
        
        updateTimeRange() {
            if (this.timeRange === 'custom') {
                // Show date picker modal
                alert('Custom date range picker would open here');
            }
        },
        
        updateThreshold() {
            // Update anomaly threshold in real-time
            console.log('Threshold updated:', this.anomalyThreshold);
        },
        
        toggleRealTime() {
            this.realTimeEnabled = !this.realTimeEnabled;
        },
        
        seekTimeline(event) {
            const rect = event.currentTarget.getBoundingClientRect();
            const x = event.clientX - rect.left;
            this.timelinePosition = (x / rect.width) * 100;
        },
        
        startDragging(event) {
            const startX = event.clientX;
            const startPosition = this.timelinePosition;
            
            const handleMouseMove = (e) => {
                const deltaX = e.clientX - startX;
                const container = event.currentTarget.parentElement;
                const newPosition = startPosition + (deltaX / container.clientWidth) * 100;
                this.timelinePosition = Math.max(0, Math.min(100, newPosition));
            };
            
            const handleMouseUp = () => {
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            };
            
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        },
        
        updateComparison() {
            // Update comparison chart based on selected metric
            console.log('Updating comparison for metric:', this.comparisonMetric);
        },
        
        updateHeatmap() {
            // Update heatmap based on selected dimension
            console.log('Updating heatmap for dimension:', this.heatmapDimension);
        },
        
        // Table functions
        filterTable() {
            // Filtering is handled by computed property
        },
        
        sortTable(field) {
            if (this.tableSortField === field) {
                this.tableSortDirection = this.tableSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                this.tableSortField = field;
                this.tableSortDirection = 'desc';
            }
        },
        
        getSortIcon(field) {
            if (this.tableSortField !== field) return 'fas fa-sort text-gray-400';
            return this.tableSortDirection === 'asc' ? 'fas fa-sort-up text-blue-600' : 'fas fa-sort-down text-blue-600';
        },
        
        getScoreColor(score) {
            if (score > 0.8) return 'bg-red-500';
            if (score > 0.6) return 'bg-yellow-500';
            return 'bg-green-500';
        },
        
        formatDateTime(date) {
            return new Date(date).toLocaleString();
        },
        
        showAnomalyDetails(anomaly) {
            alert(`Anomaly Details:\nID: ${anomaly.id}\nScore: ${anomaly.score}\nAlgorithm: ${anomaly.algorithm}`);
        },
        
        explainAnomaly(anomaly) {
            alert(`SHAP explanation for anomaly ${anomaly.id} would be shown here`);
        },
        
        flagAnomaly(anomaly) {
            alert(`Flagging anomaly ${anomaly.id} for review`);
        },
        
        // Chart controls
        zoomIn(chartId) {
            console.log(`Zooming in on ${chartId} chart`);
        },
        
        zoomOut(chartId) {
            console.log(`Zooming out on ${chartId} chart`);
        },
        
        resetZoom(chartId) {
            console.log(`Resetting zoom on ${chartId} chart`);
        },
        
        // Export functions
        showExportMenu(chartId) {
            this.showExportMenuFor = this.showExportMenuFor === chartId ? null : chartId;
        },
        
        exportChart(format) {
            alert(`Exporting ${this.showExportMenuFor} chart as ${format.toUpperCase()}`);
            this.showExportMenuFor = null;
        },
        
        exportTable() {
            alert('Exporting table data as CSV');
        },
        
        exportDashboard() {
            alert('Exporting entire dashboard');
        },
        
        // Model comparison
        addModelToComparison() {
            alert('Add model to comparison dialog would open here');
        },
        
        removeFromComparison(model) {
            const index = this.comparisonModels.findIndex(m => m.id === model.id);
            if (index > -1) {
                this.comparisonModels.splice(index, 1);
            }
        },
        
        // Filter presets
        resetFilters() {
            this.selectedDataset = 'financial-fraud';
            this.selectedAlgorithm = '';
            this.timeRange = '24h';
            this.anomalyThreshold = 0.5;
            this.confidenceLevel = 0.95;
            this.contaminationRate = 0.1;
            this.sampleSize = 1000;
        },
        
        saveFilterPreset() {
            alert('Save filter preset dialog would open here');
        },
        
        // Additional features
        addCustomChart() {
            alert('Custom chart builder would open here');
        },
        
        shareVisualization() {
            alert('Share visualization dialog would open here');
        }
    };
}
</script>
{% endblock %}