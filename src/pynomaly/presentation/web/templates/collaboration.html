{% extends "base.html" %}

{% block title %}Collaboration Hub - Pynomaly{% endblock %}

{% block head %}
<style>
    .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 12px;
        color: white;
        margin-right: 8px;
    }
    .user-status-online { background: #10B981; }
    .user-status-away { background: #F59E0B; }
    .user-status-offline { background: #6B7280; }
    
    .comment-thread {
        border-left: 3px solid #E5E7EB;
        padding-left: 16px;
        margin-left: 16px;
    }
    
    .activity-item {
        position: relative;
        padding-left: 24px;
    }
    .activity-item::before {
        content: '';
        position: absolute;
        left: 8px;
        top: 8px;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #3B82F6;
    }
    
    .notification-badge {
        background: #EF4444;
        color: white;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 10px;
        position: absolute;
        top: -4px;
        right: -4px;
    }
    
    .live-cursor {
        position: absolute;
        pointer-events: none;
        z-index: 1000;
        transition: all 0.1s ease;
    }
    
    .live-cursor svg {
        width: 20px;
        height: 20px;
    }
    
    .live-selection {
        background: rgba(59, 130, 246, 0.2);
        border: 1px solid #3B82F6;
        position: absolute;
        pointer-events: none;
        z-index: 999;
    }
    
    .chat-message {
        animation: slideInUp 0.3s ease-out;
    }
    
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .typing-indicator {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        background: #F3F4F6;
        border-radius: 12px;
        margin: 4px 0;
    }
    
    .typing-dots {
        display: flex;
        gap: 2px;
    }
    
    .typing-dot {
        width: 4px;
        height: 4px;
        background: #6B7280;
        border-radius: 50%;
        animation: typingBounce 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typingBounce {
        0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
    }
    
    .version-diff {
        background: #FEF3C7;
        border-left: 4px solid #F59E0B;
        padding: 12px;
        margin: 8px 0;
    }
    
    .diff-added { background: #D1FAE5; }
    .diff-removed { background: #FEE2E2; text-decoration: line-through; }
    .diff-modified { background: #DBEAFE; }
</style>
{% endblock %}

{% block content %}
<div x-data="collaborationHub()" class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="px-6 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Collaboration Hub</h1>
                    <p class="text-gray-600 mt-1">Real-time collaboration for anomaly detection projects</p>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Active Users -->
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-600">Active users:</span>
                        <div class="flex -space-x-2">
                            <template x-for="user in activeUsers" :key="user.id">
                                <div class="relative">
                                    <div :class="`user-avatar user-status-${user.status}`" 
                                         :title="user.name"
                                         x-text="user.initials"></div>
                                    <div x-show="user.unreadCount > 0" 
                                         class="notification-badge" 
                                         x-text="user.unreadCount"></div>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <button @click="shareProject()" 
                            class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-share mr-2"></i>Share Project
                    </button>
                    <button @click="showSettings = true" 
                            class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        <i class="fas fa-cog mr-2"></i>Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="flex h-full">
        <!-- Main Content Area -->
        <div class="flex-1 p-6">
            <!-- Project Overview -->
            <div class="bg-white rounded-lg shadow-sm border mb-6">
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h2 class="text-xl font-semibold text-gray-900" x-text="currentProject.name"></h2>
                            <p class="text-gray-600 mt-1" x-text="currentProject.description"></p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span :class="`px-2 py-1 rounded-full text-xs font-medium ${getProjectStatusClass(currentProject.status)}`"
                                  x-text="currentProject.status"></span>
                            <button @click="showVersionHistory = true" 
                                    class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-history"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Project Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600" x-text="projectStats.totalCollaborators"></div>
                            <div class="text-sm text-blue-600">Collaborators</div>
                        </div>
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <div class="text-2xl font-bold text-green-600" x-text="projectStats.activeExperiments"></div>
                            <div class="text-sm text-green-600">Active Experiments</div>
                        </div>
                        <div class="text-center p-4 bg-yellow-50 rounded-lg">
                            <div class="text-2xl font-bold text-yellow-600" x-text="projectStats.commentsToday"></div>
                            <div class="text-sm text-yellow-600">Comments Today</div>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-lg">
                            <div class="text-2xl font-bold text-purple-600" x-text="projectStats.versionsCreated"></div>
                            <div class="text-sm text-purple-600">Versions</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Real-time Activity Feed -->
            <div class="bg-white rounded-lg shadow-sm border mb-6">
                <div class="p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Recent Activity</h3>
                    <div class="space-y-4 max-h-64 overflow-y-auto">
                        <template x-for="activity in recentActivity" :key="activity.id">
                            <div class="activity-item">
                                <div class="flex items-start space-x-3">
                                    <div :class="`user-avatar user-status-${activity.user.status}`" 
                                         x-text="activity.user.initials"></div>
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-2">
                                            <span class="font-medium text-gray-900" x-text="activity.user.name"></span>
                                            <span class="text-sm text-gray-500" x-text="activity.action"></span>
                                            <span class="text-xs text-gray-400" x-text="formatTime(activity.timestamp)"></span>
                                        </div>
                                        <div class="text-sm text-gray-600 mt-1" x-text="activity.details"></div>
                                        <div x-show="activity.changes" class="mt-2">
                                            <template x-for="change in activity.changes" :key="change.id">
                                                <div :class="`text-xs px-2 py-1 rounded ${getDiffClass(change.type)}`"
                                                     x-text="change.description"></div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            
            <!-- Shared Experiments -->
            <div class="bg-white rounded-lg shadow-sm border">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Shared Experiments</h3>
                        <button @click="createSharedExperiment()" 
                                class="bg-secondary text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition-colors">
                            <i class="fas fa-plus mr-1"></i>New Experiment
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <template x-for="experiment in sharedExperiments" :key="experiment.id">
                            <div class="border border-gray-200 rounded-lg p-4 hover:border-primary hover:shadow-md transition-all cursor-pointer"
                                 @click="openExperiment(experiment)">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="font-medium text-gray-900" x-text="experiment.name"></h4>
                                    <div class="flex -space-x-1">
                                        <template x-for="collaborator in experiment.collaborators.slice(0, 3)" :key="collaborator.id">
                                            <div :class="`user-avatar user-status-${collaborator.status}`" 
                                                 style="width: 20px; height: 20px; font-size: 10px;"
                                                 :title="collaborator.name"
                                                 x-text="collaborator.initials"></div>
                                        </template>
                                        <div x-show="experiment.collaborators.length > 3" 
                                             class="user-avatar bg-gray-400" 
                                             style="width: 20px; height: 20px; font-size: 10px;"
                                             x-text="`+${experiment.collaborators.length - 3}`"></div>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-600 mb-3" x-text="experiment.description"></p>
                                <div class="flex items-center justify-between text-xs text-gray-500">
                                    <span x-text="`${experiment.models} models`"></span>
                                    <span x-text="formatDate(experiment.lastModified)"></span>
                                </div>
                                <div x-show="experiment.hasComments" class="mt-2">
                                    <div class="flex items-center text-xs text-blue-600">
                                        <i class="fas fa-comments mr-1"></i>
                                        <span x-text="`${experiment.commentCount} comments`"></span>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="w-80 bg-white shadow-lg border-l">
            <!-- Tabs -->
            <div class="border-b">
                <div class="flex">
                    <button @click="activeTab = 'chat'" 
                            :class="activeTab === 'chat' ? 'border-primary text-primary' : 'border-transparent text-gray-500'"
                            class="flex-1 py-3 px-4 border-b-2 text-sm font-medium hover:text-gray-700">
                        <i class="fas fa-comments mr-2"></i>Chat
                        <span x-show="unreadMessages > 0" 
                              class="notification-badge" 
                              x-text="unreadMessages"></span>
                    </button>
                    <button @click="activeTab = 'comments'" 
                            :class="activeTab === 'comments' ? 'border-primary text-primary' : 'border-transparent text-gray-500'"
                            class="flex-1 py-3 px-4 border-b-2 text-sm font-medium hover:text-gray-700">
                        <i class="fas fa-comment-dots mr-2"></i>Comments
                        <span x-show="unreadComments > 0" 
                              class="notification-badge" 
                              x-text="unreadComments"></span>
                    </button>
                </div>
            </div>
            
            <!-- Chat Tab -->
            <div x-show="activeTab === 'chat'" class="flex flex-col h-96">
                <!-- Chat Messages -->
                <div class="flex-1 p-4 overflow-y-auto space-y-3" id="chat-messages">
                    <template x-for="message in chatMessages" :key="message.id">
                        <div class="chat-message">
                            <div class="flex items-start space-x-2">
                                <div :class="`user-avatar user-status-${message.user.status}`" 
                                     style="width: 24px; height: 24px; font-size: 10px;"
                                     x-text="message.user.initials"></div>
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-sm font-medium text-gray-900" x-text="message.user.name"></span>
                                        <span class="text-xs text-gray-500" x-text="formatTime(message.timestamp)"></span>
                                    </div>
                                    <div class="text-sm text-gray-700 mt-1" x-text="message.content"></div>
                                    <div x-show="message.attachment" class="mt-2">
                                        <div class="bg-gray-100 rounded p-2 text-xs">
                                            <i class="fas fa-paperclip mr-1"></i>
                                            <span x-text="message.attachment?.name"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                    
                    <!-- Typing Indicators -->
                    <div x-show="usersTyping.length > 0" class="typing-indicator">
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                        <span class="text-xs text-gray-600 ml-2">
                            <span x-text="getTypingText()"></span> typing...
                        </span>
                    </div>
                </div>
                
                <!-- Chat Input -->
                <div class="p-4 border-t">
                    <div class="flex space-x-2">
                        <input type="text" x-model="newMessage" 
                               @keyup.enter="sendMessage()"
                               @input="handleTyping()"
                               placeholder="Type a message..."
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-sm">
                        <button @click="sendMessage()" 
                                :disabled="!newMessage.trim()"
                                class="bg-primary text-white px-3 py-2 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition-colors">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Comments Tab -->
            <div x-show="activeTab === 'comments'" class="h-96 overflow-y-auto p-4">
                <div class="space-y-4">
                    <template x-for="comment in projectComments" :key="comment.id">
                        <div class="border-l-4 border-blue-200 pl-4">
                            <div class="flex items-start space-x-2">
                                <div :class="`user-avatar user-status-${comment.user.status}`" 
                                     style="width: 24px; height: 24px; font-size: 10px;"
                                     x-text="comment.user.initials"></div>
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-sm font-medium text-gray-900" x-text="comment.user.name"></span>
                                        <span class="text-xs text-gray-500" x-text="formatTime(comment.timestamp)"></span>
                                    </div>
                                    <div class="text-sm text-gray-700 mt-1" x-text="comment.content"></div>
                                    <div x-show="comment.context" class="mt-2 text-xs text-gray-500">
                                        On: <span x-text="comment.context"></span>
                                    </div>
                                    
                                    <!-- Replies -->
                                    <div x-show="comment.replies && comment.replies.length > 0" class="comment-thread mt-3">
                                        <template x-for="reply in comment.replies" :key="reply.id">
                                            <div class="flex items-start space-x-2 mb-2">
                                                <div :class="`user-avatar user-status-${reply.user.status}`" 
                                                     style="width: 20px; height: 20px; font-size: 9px;"
                                                     x-text="reply.user.initials"></div>
                                                <div class="flex-1">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="text-xs font-medium text-gray-900" x-text="reply.user.name"></span>
                                                        <span class="text-xs text-gray-500" x-text="formatTime(reply.timestamp)"></span>
                                                    </div>
                                                    <div class="text-xs text-gray-700 mt-1" x-text="reply.content"></div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                    
                                    <button @click="showReplyForm = comment.id" 
                                            class="text-xs text-blue-600 hover:text-blue-800 mt-2">
                                        Reply
                                    </button>
                                    
                                    <!-- Reply Form -->
                                    <div x-show="showReplyForm === comment.id" class="mt-2">
                                        <div class="flex space-x-2">
                                            <input type="text" x-model="replyContent" 
                                                   @keyup.enter="addReply(comment)"
                                                   placeholder="Add a reply..."
                                                   class="flex-1 px-2 py-1 border border-gray-300 rounded text-xs focus:ring-1 focus:ring-primary focus:border-transparent">
                                            <button @click="addReply(comment)" 
                                                    class="bg-primary text-white px-2 py-1 rounded text-xs hover:bg-blue-700">
                                                Reply
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Live Cursors -->
    <template x-for="cursor in liveCursors" :key="cursor.userId">
        <div class="live-cursor" 
             :style="`left: ${cursor.x}px; top: ${cursor.y}px;`">
            <svg viewBox="0 0 24 24" :fill="cursor.color">
                <path d="M6 2L3 6V18L6 22H18L21 18V6L18 2H6Z"/>
            </svg>
            <div class="text-xs bg-gray-800 text-white px-2 py-1 rounded ml-6 -mt-6"
                 x-text="cursor.userName"></div>
        </div>
    </template>
    
    <!-- Version History Modal -->
    <div x-show="showVersionHistory" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-gray-900">Version History</h2>
                    <button @click="showVersionHistory = false" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="space-y-4">
                    <template x-for="version in projectVersions" :key="version.id">
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center space-x-3">
                                    <div :class="`user-avatar user-status-${version.author.status}`" 
                                         x-text="version.author.initials"></div>
                                    <div>
                                        <div class="font-medium text-gray-900" x-text="version.name"></div>
                                        <div class="text-sm text-gray-500">
                                            by <span x-text="version.author.name"></span> • 
                                            <span x-text="formatDate(version.timestamp)"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button @click="compareVersions(version)" 
                                            class="text-blue-600 hover:text-blue-800 text-sm">
                                        Compare
                                    </button>
                                    <button @click="restoreVersion(version)" 
                                            class="text-green-600 hover:text-green-800 text-sm">
                                        Restore
                                    </button>
                                </div>
                            </div>
                            <div class="text-sm text-gray-700" x-text="version.description"></div>
                            <div x-show="version.changes" class="mt-3 space-y-1">
                                <template x-for="change in version.changes" :key="change.id">
                                    <div :class="`text-xs px-2 py-1 rounded ${getDiffClass(change.type)}`"
                                         x-text="change.description"></div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function collaborationHub() {
    return {
        activeTab: 'chat',
        showVersionHistory: false,
        showSettings: false,
        showReplyForm: null,
        newMessage: '',
        replyContent: '',
        unreadMessages: 0,
        unreadComments: 0,
        usersTyping: [],
        liveCursors: [],
        
        currentProject: {
            id: 'proj-1',
            name: 'Financial Fraud Detection',
            description: 'Collaborative anomaly detection for financial transaction data',
            status: 'active'
        },
        
        projectStats: {
            totalCollaborators: 5,
            activeExperiments: 3,
            commentsToday: 12,
            versionsCreated: 8
        },
        
        activeUsers: [
            { id: 1, name: 'Alice Johnson', initials: 'AJ', status: 'online', unreadCount: 0 },
            { id: 2, name: 'Bob Smith', initials: 'BS', status: 'online', unreadCount: 2 },
            { id: 3, name: 'Carol Davis', initials: 'CD', status: 'away', unreadCount: 0 },
            { id: 4, name: 'David Wilson', initials: 'DW', status: 'online', unreadCount: 1 },
            { id: 5, name: 'Eva Brown', initials: 'EB', status: 'offline', unreadCount: 0 }
        ],
        
        recentActivity: [
            {
                id: 1,
                user: { name: 'Alice Johnson', initials: 'AJ', status: 'online' },
                action: 'updated model',
                details: 'Improved Isolation Forest parameters',
                timestamp: new Date(Date.now() - 300000),
                changes: [
                    { id: 1, type: 'modified', description: 'contamination: 0.1 → 0.08' },
                    { id: 2, type: 'added', description: 'max_samples: auto' }
                ]
            },
            {
                id: 2,
                user: { name: 'Bob Smith', initials: 'BS', status: 'online' },
                action: 'commented on',
                details: 'Added feedback on feature selection approach',
                timestamp: new Date(Date.now() - 600000)
            },
            {
                id: 3,
                user: { name: 'Carol Davis', initials: 'CD', status: 'away' },
                action: 'created experiment',
                details: 'LOF vs DBSCAN comparison',
                timestamp: new Date(Date.now() - 900000)
            }
        ],
        
        sharedExperiments: [
            {
                id: 1,
                name: 'Isolation Forest Tuning',
                description: 'Hyperparameter optimization for IF algorithm',
                collaborators: [
                    { id: 1, name: 'Alice', initials: 'A', status: 'online' },
                    { id: 2, name: 'Bob', initials: 'B', status: 'online' }
                ],
                models: 12,
                lastModified: new Date(Date.now() - 3600000),
                hasComments: true,
                commentCount: 5
            },
            {
                id: 2,
                name: 'Ensemble Comparison',
                description: 'Comparing voting vs stacking ensemble methods',
                collaborators: [
                    { id: 3, name: 'Carol', initials: 'C', status: 'away' },
                    { id: 4, name: 'David', initials: 'D', status: 'online' },
                    { id: 5, name: 'Eva', initials: 'E', status: 'offline' }
                ],
                models: 8,
                lastModified: new Date(Date.now() - 7200000),
                hasComments: false,
                commentCount: 0
            }
        ],
        
        chatMessages: [
            {
                id: 1,
                user: { name: 'Alice', initials: 'A', status: 'online' },
                content: 'The new contamination rate is working much better!',
                timestamp: new Date(Date.now() - 1800000)
            },
            {
                id: 2,
                user: { name: 'Bob', initials: 'B', status: 'online' },
                content: 'Great! What about the false positive rate?',
                timestamp: new Date(Date.now() - 1200000)
            },
            {
                id: 3,
                user: { name: 'Alice', initials: 'A', status: 'online' },
                content: 'Down to 2.3% from 4.1%. Much improvement!',
                timestamp: new Date(Date.now() - 600000)
            }
        ],
        
        projectComments: [
            {
                id: 1,
                user: { name: 'Carol', initials: 'C', status: 'away' },
                content: 'Consider using SHAP values for better interpretability',
                context: 'Model Explanation',
                timestamp: new Date(Date.now() - 3600000),
                replies: [
                    {
                        id: 1,
                        user: { name: 'David', initials: 'D', status: 'online' },
                        content: 'Good idea! I\'ll implement that.',
                        timestamp: new Date(Date.now() - 3000000)
                    }
                ]
            },
            {
                id: 2,
                user: { name: 'Eva', initials: 'E', status: 'offline' },
                content: 'The feature scaling might need adjustment for this dataset',
                context: 'Data Preprocessing',
                timestamp: new Date(Date.now() - 7200000),
                replies: []
            }
        ],
        
        projectVersions: [
            {
                id: 1,
                name: 'v1.3.0 - Enhanced Feature Selection',
                description: 'Added recursive feature elimination and improved preprocessing',
                author: { name: 'Alice Johnson', initials: 'AJ', status: 'online' },
                timestamp: new Date(Date.now() - 86400000),
                changes: [
                    { id: 1, type: 'added', description: 'Recursive Feature Elimination' },
                    { id: 2, type: 'modified', description: 'StandardScaler → RobustScaler' },
                    { id: 3, type: 'removed', description: 'Manual feature selection' }
                ]
            },
            {
                id: 2,
                name: 'v1.2.1 - Hotfix for contamination rate',
                description: 'Fixed contamination rate calculation bug',
                author: { name: 'Bob Smith', initials: 'BS', status: 'online' },
                timestamp: new Date(Date.now() - 172800000),
                changes: [
                    { id: 1, type: 'modified', description: 'contamination calculation fixed' }
                ]
            }
        ],
        
        init() {
            this.setupWebSocket();
            this.simulateLiveActivity();
        },
        
        setupWebSocket() {
            // Simulate WebSocket connection for real-time updates
            setInterval(() => {
                this.updateLiveCursors();
                this.checkNewMessages();
            }, 1000);
        },
        
        simulateLiveActivity() {
            // Simulate typing indicators
            setInterval(() => {
                if (Math.random() < 0.1) {
                    const user = this.activeUsers[Math.floor(Math.random() * this.activeUsers.length)];
                    if (!this.usersTyping.includes(user.name)) {
                        this.usersTyping.push(user.name);
                        setTimeout(() => {
                            this.usersTyping = this.usersTyping.filter(u => u !== user.name);
                        }, 3000);
                    }
                }
            }, 2000);
        },
        
        updateLiveCursors() {
            // Simulate live cursor movements
            this.liveCursors = this.activeUsers
                .filter(user => user.status === 'online' && user.id !== 1) // Exclude current user
                .map(user => ({
                    userId: user.id,
                    userName: user.name,
                    x: Math.random() * window.innerWidth,
                    y: Math.random() * window.innerHeight,
                    color: this.getUserColor(user.id)
                }));
        },
        
        checkNewMessages() {
            // Simulate new message notifications
            if (Math.random() < 0.05) {
                this.unreadMessages++;
            }
        },
        
        sendMessage() {
            if (!this.newMessage.trim()) return;
            
            const message = {
                id: Date.now(),
                user: { name: 'You', initials: 'Y', status: 'online' },
                content: this.newMessage,
                timestamp: new Date()
            };
            
            this.chatMessages.push(message);
            this.newMessage = '';
            this.scrollToBottom();
        },
        
        handleTyping() {
            // Handle typing indicator
            clearTimeout(this.typingTimeout);
            this.typingTimeout = setTimeout(() => {
                // Stop typing indicator
            }, 1000);
        },
        
        addReply(comment) {
            if (!this.replyContent.trim()) return;
            
            const reply = {
                id: Date.now(),
                user: { name: 'You', initials: 'Y', status: 'online' },
                content: this.replyContent,
                timestamp: new Date()
            };
            
            if (!comment.replies) comment.replies = [];
            comment.replies.push(reply);
            this.replyContent = '';
            this.showReplyForm = null;
        },
        
        scrollToBottom() {
            this.$nextTick(() => {
                const chatContainer = document.getElementById('chat-messages');
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        },
        
        formatTime(date) {
            return new Date(date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        },
        
        formatDate(date) {
            return new Date(date).toLocaleDateString();
        },
        
        getTypingText() {
            if (this.usersTyping.length === 1) {
                return this.usersTyping[0];
            } else if (this.usersTyping.length === 2) {
                return this.usersTyping.join(' and ');
            } else {
                return `${this.usersTyping.slice(0, -1).join(', ')} and ${this.usersTyping[this.usersTyping.length - 1]}`;
            }
        },
        
        getUserColor(userId) {
            const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'];
            return colors[userId % colors.length];
        },
        
        getProjectStatusClass(status) {
            switch (status) {
                case 'active': return 'bg-green-100 text-green-800';
                case 'paused': return 'bg-yellow-100 text-yellow-800';
                case 'completed': return 'bg-blue-100 text-blue-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        },
        
        getDiffClass(type) {
            switch (type) {
                case 'added': return 'diff-added';
                case 'removed': return 'diff-removed';
                case 'modified': return 'diff-modified';
                default: return '';
            }
        },
        
        shareProject() {
            // Implement project sharing
            alert('Project sharing functionality would be implemented here');
        },
        
        createSharedExperiment() {
            // Implement experiment creation
            alert('Shared experiment creation would be implemented here');
        },
        
        openExperiment(experiment) {
            // Navigate to experiment
            alert(`Opening experiment: ${experiment.name}`);
        },
        
        compareVersions(version) {
            // Implement version comparison
            alert(`Comparing version: ${version.name}`);
        },
        
        restoreVersion(version) {
            // Implement version restoration
            if (confirm(`Restore to ${version.name}?`)) {
                alert('Version restored successfully');
            }
        }
    };
}
</script>
{% endblock %}