{% extends "base.html" %} {% block title %}Monitoring - Pynomaly{% endblock %}
{% block content %}
<div class="px-4 py-6 sm:px-0">
  <!-- Header -->
  <div class="mb-8 flex justify-between items-center">
    <div>
      <h1 class="text-3xl font-bold text-gray-900">üìä Real-time Monitoring</h1>
      <p class="mt-2 text-gray-600">
        System health, performance metrics, and operational insights
      </p>
    </div>
    <div class="flex space-x-3">
      <button
        onclick="refreshAllDashboards()"
        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary"
      >
        <svg
          class="-ml-1 mr-2 h-5 w-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
          />
        </svg>
        Refresh All
      </button>
      <button
        onclick="toggleAutoRefresh()"
        id="auto-refresh-btn"
        class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary"
      >
        <svg
          class="-ml-1 mr-2 h-5 w-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
          />
        </svg>
        Auto-refresh: ON
      </button>
    </div>
  </div>

  <!-- System Health Overview -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div
      id="system-health-card"
      hx-get="/htmx/monitoring-health"
      hx-trigger="load, every 10s"
      class="bg-white overflow-hidden shadow rounded-lg"
    >
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div
              class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center"
            >
              <svg
                class="w-5 h-5 text-green-600"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-sm font-medium text-gray-500 truncate">
                System Health
              </dt>
              <dd class="text-lg font-medium text-gray-900">Healthy</dd>
            </dl>
          </div>
        </div>
      </div>
    </div>

    <div
      id="active-detections-card"
      hx-get="/htmx/monitoring-active"
      hx-trigger="load, every 5s"
      class="bg-white overflow-hidden shadow rounded-lg"
    >
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div
              class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center"
            >
              <svg
                class="w-5 h-5 text-blue-600"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-sm font-medium text-gray-500 truncate">
                Active Detections
              </dt>
              <dd class="text-lg font-medium text-gray-900">Loading...</dd>
            </dl>
          </div>
        </div>
      </div>
    </div>

    <div
      id="performance-card"
      hx-get="/htmx/monitoring-performance"
      hx-trigger="load, every 15s"
      class="bg-white overflow-hidden shadow rounded-lg"
    >
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div
              class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center"
            >
              <svg
                class="w-5 h-5 text-yellow-600"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-sm font-medium text-gray-500 truncate">
                Avg Response Time
              </dt>
              <dd class="text-lg font-medium text-gray-900">Loading...</dd>
            </dl>
          </div>
        </div>
      </div>
    </div>

    <div
      id="error-rate-card"
      hx-get="/htmx/monitoring-errors"
      hx-trigger="load, every 20s"
      class="bg-white overflow-hidden shadow rounded-lg"
    >
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div
              class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center"
            >
              <svg
                class="w-5 h-5 text-red-600"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-sm font-medium text-gray-500 truncate">
                Error Rate
              </dt>
              <dd class="text-lg font-medium text-gray-900">Loading...</dd>
            </dl>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Real-time Charts -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <!-- Detection Timeline -->
    <div class="bg-white shadow rounded-lg">
      <div class="px-4 py-5 sm:p-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
          üïê Detection Timeline
        </h3>
        <div id="detection-timeline-chart" class="h-64"></div>
        <div class="mt-4 text-sm text-gray-500">
          Real-time anomaly detection activity over the last 24 hours
        </div>
      </div>
    </div>

    <!-- Performance Metrics -->
    <div class="bg-white shadow rounded-lg">
      <div class="px-4 py-5 sm:p-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
          ‚ö° Performance Metrics
        </h3>
        <div id="performance-metrics-chart" class="h-64"></div>
        <div class="mt-4 text-sm text-gray-500">
          Response times, throughput, and resource utilization
        </div>
      </div>
    </div>
  </div>

  <!-- System Resources -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
    <!-- CPU Usage -->
    <div class="bg-white shadow rounded-lg">
      <div class="px-4 py-5 sm:p-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
          üíª CPU Usage
        </h3>
        <div id="cpu-usage-gauge" class="h-48 flex items-center justify-center">
          <div class="text-center">
            <div class="text-3xl font-bold text-blue-600" id="cpu-percentage">
              --
            </div>
            <div class="text-sm text-gray-500">CPU Usage</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Memory Usage -->
    <div class="bg-white shadow rounded-lg">
      <div class="px-4 py-5 sm:p-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
          üß† Memory Usage
        </h3>
        <div
          id="memory-usage-gauge"
          class="h-48 flex items-center justify-center"
        >
          <div class="text-center">
            <div
              class="text-3xl font-bold text-green-600"
              id="memory-percentage"
            >
              --
            </div>
            <div class="text-sm text-gray-500">Memory Usage</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Active Connections -->
    <div class="bg-white shadow rounded-lg">
      <div class="px-4 py-5 sm:p-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
          üîó Active Connections
        </h3>
        <div
          id="connections-gauge"
          class="h-48 flex items-center justify-center"
        >
          <div class="text-center">
            <div
              class="text-3xl font-bold text-purple-600"
              id="connections-count"
            >
              --
            </div>
            <div class="text-sm text-gray-500">Active Connections</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Activity and Alerts -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- Recent Activity -->
    <div class="bg-white shadow rounded-lg">
      <div class="px-4 py-5 sm:p-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
          üìà Recent Activity
        </h3>
        <div
          id="recent-activity"
          hx-get="/htmx/monitoring-activity"
          hx-trigger="load, every 30s"
          class="space-y-4"
        >
          <div class="animate-pulse">
            <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
            <div class="h-4 bg-gray-200 rounded w-1/2 mb-2"></div>
            <div class="h-4 bg-gray-200 rounded w-2/3"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Alerts and Notifications -->
    <div class="bg-white shadow rounded-lg">
      <div class="px-4 py-5 sm:p-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
          üö® Alerts & Notifications
        </h3>
        <div
          id="alerts-panel"
          hx-get="/htmx/monitoring-alerts"
          hx-trigger="load, every 15s"
          class="space-y-4"
        >
          <div class="bg-green-50 border border-green-200 rounded p-3">
            <div class="flex items-center">
              <svg
                class="h-5 w-5 text-green-400 mr-2"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                  clip-rule="evenodd"
                />
              </svg>
              <span class="text-sm text-green-800"
                >All systems operational</span
              >
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Detailed Metrics Tables -->
  <div class="mt-8 bg-white shadow rounded-lg">
    <div class="px-4 py-5 sm:p-6">
      <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
        üìã Detailed Metrics
      </h3>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Detection Statistics -->
        <div>
          <h4 class="font-medium text-gray-900 mb-3">
            Detection Statistics (Last 24h)
          </h4>
          <div
            id="detection-stats"
            hx-get="/htmx/monitoring-detection-stats"
            hx-trigger="load, every 60s"
            class="overflow-hidden"
          >
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Metric
                  </th>
                  <th
                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Value
                  </th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <tr>
                  <td class="px-3 py-2 text-sm text-gray-900">Loading...</td>
                  <td class="px-3 py-2 text-sm text-gray-500">--</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Performance Statistics -->
        <div>
          <h4 class="font-medium text-gray-900 mb-3">Performance Statistics</h4>
          <div
            id="performance-stats"
            hx-get="/htmx/monitoring-performance-stats"
            hx-trigger="load, every 60s"
            class="overflow-hidden"
          >
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Metric
                  </th>
                  <th
                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Value
                  </th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <tr>
                  <td class="px-3 py-2 text-sm text-gray-900">Loading...</td>
                  <td class="px-3 py-2 text-sm text-gray-500">--</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Global monitoring state
  let autoRefreshEnabled = true;
  let refreshIntervals = [];

  // Auto-refresh toggle
  function toggleAutoRefresh() {
    autoRefreshEnabled = !autoRefreshEnabled;
    const btn = document.getElementById("auto-refresh-btn");

    if (autoRefreshEnabled) {
      btn.innerHTML = btn.innerHTML.replace(
        "Auto-refresh: OFF",
        "Auto-refresh: ON",
      );
      btn.classList.remove("bg-red-100", "text-red-700");
      btn.classList.add("bg-white", "text-gray-700");
      startAutoRefresh();
    } else {
      btn.innerHTML = btn.innerHTML.replace(
        "Auto-refresh: ON",
        "Auto-refresh: OFF",
      );
      btn.classList.remove("bg-white", "text-gray-700");
      btn.classList.add("bg-red-100", "text-red-700");
      stopAutoRefresh();
    }
  }

  // Refresh all dashboards
  function refreshAllDashboards() {
    htmx.trigger("#system-health-card", "refresh");
    htmx.trigger("#active-detections-card", "refresh");
    htmx.trigger("#performance-card", "refresh");
    htmx.trigger("#error-rate-card", "refresh");
    htmx.trigger("#recent-activity", "refresh");
    htmx.trigger("#alerts-panel", "refresh");
    htmx.trigger("#detection-stats", "refresh");
    htmx.trigger("#performance-stats", "refresh");

    updateCharts();
    updateResourceGauges();
  }

  // Start auto-refresh
  function startAutoRefresh() {
    // Already handled by HTMX hx-trigger attributes
    updateResourceGauges();
  }

  // Stop auto-refresh
  function stopAutoRefresh() {
    refreshIntervals.forEach((interval) => clearInterval(interval));
    refreshIntervals = [];
  }

  // Update resource gauges
  function updateResourceGauges() {
    // Simulate real-time resource data
    const cpuUsage = Math.floor(Math.random() * 40) + 20; // 20-60%
    const memoryUsage = Math.floor(Math.random() * 30) + 40; // 40-70%
    const connections = Math.floor(Math.random() * 50) + 10; // 10-60

    document.getElementById("cpu-percentage").textContent = cpuUsage + "%";
    document.getElementById("memory-percentage").textContent =
      memoryUsage + "%";
    document.getElementById("connections-count").textContent = connections;

    // Update gauge colors based on usage
    const cpuElement = document.getElementById("cpu-percentage");
    const memoryElement = document.getElementById("memory-percentage");

    // CPU color coding
    cpuElement.className = `text-3xl font-bold ${cpuUsage > 80 ? "text-red-600" : cpuUsage > 60 ? "text-yellow-600" : "text-blue-600"}`;

    // Memory color coding
    memoryElement.className = `text-3xl font-bold ${memoryUsage > 80 ? "text-red-600" : memoryUsage > 60 ? "text-yellow-600" : "text-green-600"}`;
  }

  // Initialize charts
  function initializeCharts() {
    // Detection Timeline Chart
    createDetectionTimelineChart();

    // Performance Metrics Chart
    createPerformanceMetricsChart();
  }

  // Create detection timeline chart
  function createDetectionTimelineChart() {
    const margin = { top: 20, right: 30, bottom: 40, left: 50 };
    const width = 500 - margin.left - margin.right;
    const height = 220 - margin.top - margin.bottom;

    // Clear existing chart
    d3.select("#detection-timeline-chart").selectAll("*").remove();

    const svg = d3
      .select("#detection-timeline-chart")
      .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    // Generate sample data
    const now = new Date();
    const data = [];
    for (let i = 23; i >= 0; i--) {
      const time = new Date(now.getTime() - i * 60 * 60 * 1000);
      data.push({
        time: time,
        anomalies: Math.floor(Math.random() * 20) + 5,
      });
    }

    // Scales
    const x = d3
      .scaleTime()
      .domain(d3.extent(data, (d) => d.time))
      .range([0, width]);

    const y = d3
      .scaleLinear()
      .domain([0, d3.max(data, (d) => d.anomalies)])
      .range([height, 0]);

    // Line generator
    const line = d3
      .line()
      .x((d) => x(d.time))
      .y((d) => y(d.anomalies))
      .curve(d3.curveMonotoneX);

    // Add line
    svg
      .append("path")
      .datum(data)
      .attr("fill", "none")
      .attr("stroke", "#3B82F6")
      .attr("stroke-width", 2)
      .attr("d", line);

    // Add dots
    svg
      .selectAll(".dot")
      .data(data)
      .enter()
      .append("circle")
      .attr("class", "dot")
      .attr("cx", (d) => x(d.time))
      .attr("cy", (d) => y(d.anomalies))
      .attr("r", 3)
      .attr("fill", "#3B82F6");

    // Add axes
    svg
      .append("g")
      .attr("transform", `translate(0,${height})`)
      .call(d3.axisBottom(x).tickFormat(d3.timeFormat("%H:%M")));

    svg.append("g").call(d3.axisLeft(y));
  }

  // Create performance metrics chart
  function createPerformanceMetricsChart() {
    const margin = { top: 20, right: 30, bottom: 40, left: 50 };
    const width = 500 - margin.left - margin.right;
    const height = 220 - margin.top - margin.bottom;

    // Clear existing chart
    d3.select("#performance-metrics-chart").selectAll("*").remove();

    const svg = d3
      .select("#performance-metrics-chart")
      .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    // Generate sample data
    const now = new Date();
    const data = [];
    for (let i = 19; i >= 0; i--) {
      const time = new Date(now.getTime() - i * 5 * 60 * 1000); // 5-minute intervals
      data.push({
        time: time,
        responseTime: Math.random() * 100 + 50, // 50-150ms
        throughput: Math.random() * 500 + 200, // 200-700 req/min
      });
    }

    // Scales
    const x = d3
      .scaleTime()
      .domain(d3.extent(data, (d) => d.time))
      .range([0, width]);

    const y1 = d3
      .scaleLinear()
      .domain([0, d3.max(data, (d) => d.responseTime)])
      .range([height, 0]);

    const y2 = d3
      .scaleLinear()
      .domain([0, d3.max(data, (d) => d.throughput)])
      .range([height, 0]);

    // Line generators
    const line1 = d3
      .line()
      .x((d) => x(d.time))
      .y((d) => y1(d.responseTime))
      .curve(d3.curveMonotoneX);

    const line2 = d3
      .line()
      .x((d) => x(d.time))
      .y((d) => y2(d.throughput))
      .curve(d3.curveMonotoneX);

    // Add lines
    svg
      .append("path")
      .datum(data)
      .attr("fill", "none")
      .attr("stroke", "#EF4444")
      .attr("stroke-width", 2)
      .attr("d", line1);

    svg
      .append("path")
      .datum(data)
      .attr("fill", "none")
      .attr("stroke", "#10B981")
      .attr("stroke-width", 2)
      .attr("d", line2);

    // Add axes
    svg
      .append("g")
      .attr("transform", `translate(0,${height})`)
      .call(d3.axisBottom(x).tickFormat(d3.timeFormat("%H:%M")));

    svg.append("g").call(d3.axisLeft(y1));

    // Legend
    const legend = svg
      .append("g")
      .attr("transform", `translate(${width - 120}, 20)`);

    legend
      .append("line")
      .attr("x1", 0)
      .attr("x2", 15)
      .attr("y1", 0)
      .attr("y2", 0)
      .attr("stroke", "#EF4444")
      .attr("stroke-width", 2);

    legend
      .append("text")
      .attr("x", 20)
      .attr("y", 0)
      .attr("dy", "0.35em")
      .attr("font-size", "12px")
      .text("Response Time");

    legend
      .append("line")
      .attr("x1", 0)
      .attr("x2", 15)
      .attr("y1", 15)
      .attr("y2", 15)
      .attr("stroke", "#10B981")
      .attr("stroke-width", 2);

    legend
      .append("text")
      .attr("x", 20)
      .attr("y", 15)
      .attr("dy", "0.35em")
      .attr("font-size", "12px")
      .text("Throughput");
  }

  // Update charts periodically
  function updateCharts() {
    initializeCharts();
  }

  // Initialize everything when page loads
  document.addEventListener("DOMContentLoaded", function () {
    initializeCharts();

    if (autoRefreshEnabled) {
      startAutoRefresh();

      // Update resource gauges every 5 seconds
      setInterval(updateResourceGauges, 5000);

      // Update charts every 30 seconds
      setInterval(updateCharts, 30000);
    }
  });
</script>
{% endblock %}
