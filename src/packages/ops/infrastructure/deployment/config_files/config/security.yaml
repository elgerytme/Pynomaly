# Comprehensive Security Configuration for Pynomaly
# This file contains all security-related settings for the platform

# Authentication Configuration
authentication:
  jwt:
    secret_key: ${PYNOMALY_JWT_SECRET}  # Set via environment variable
    algorithm: "HS256"
    access_token_expiry: 86400  # 24 hours
    refresh_token_expiry: 604800  # 7 days
  
  password_policy:
    min_length: 12
    require_uppercase: true
    require_lowercase: true
    require_numbers: true
    require_special_chars: true
    forbidden_patterns:
      - "password"
      - "123456"
      - "admin"
      - "pynomaly"
  
  account_lockout:
    max_failed_attempts: 5
    lockout_duration: 900  # 15 minutes
    reset_period: 3600  # 1 hour
  
  mfa:
    enabled: true
    code_length: 6
    code_expiry: 300  # 5 minutes
    max_attempts: 3

# Authorization Configuration
authorization:
  rbac:
    enabled: true
    strict_mode: true
    cache_ttl: 300  # 5 minutes
  
  default_roles:
    - name: "guest"
      permissions:
        - "read_data"
    - name: "user"
      permissions:
        - "read_data"
        - "read_models"
    - name: "analyst"
      permissions:
        - "read_data"
        - "write_data"
        - "read_models"
    - name: "data_scientist"
      permissions:
        - "read_data"
        - "write_data"
        - "read_models"
        - "create_models"
        - "update_models"
    - name: "ml_engineer"
      permissions:
        - "read_data"
        - "write_data"
        - "read_models"
        - "create_models"
        - "update_models"
        - "delete_models"
        - "deploy_models"
    - name: "admin"
      permissions:
        - "*"  # All permissions

# Rate Limiting Configuration
rate_limiting:
  enabled: true
  strategy: "sliding_window"
  
  global_limits:
    requests_per_hour: 100000
    requests_per_minute: 10000
  
  per_user_limits:
    requests_per_hour: 1000
    requests_per_minute: 100
  
  per_ip_limits:
    requests_per_hour: 100
    requests_per_minute: 20
  
  endpoint_specific:
    "/api/v1/auth/login":
      requests_per_minute: 5
      requests_per_hour: 20
    "/api/v1/models/train":
      requests_per_hour: 10
    "/api/v1/data/upload":
      requests_per_minute: 10

# DDoS Protection Configuration
ddos_protection:
  enabled: true
  
  detection_thresholds:
    burst_requests_per_minute: 100
    sustained_requests_per_hour: 1000
    pattern_similarity: 0.8
  
  mitigation_actions:
    temporary_block_duration: 300  # 5 minutes
    permanent_block_duration: 86400  # 24 hours
    rate_limit_factor: 0.1  # Reduce allowed requests by 90%
  
  monitoring:
    alert_on_attack: true
    log_all_blocks: true
    metrics_retention: 86400  # 24 hours

# Input Validation Configuration
input_validation:
  enabled: true
  
  string_limits:
    max_length: 10000
    min_length: 0
  
  file_upload:
    max_size: 104857600  # 100MB
    allowed_extensions:
      - "csv"
      - "json"
      - "txt"
      - "parquet"
    scan_for_malware: true
  
  sql_injection_detection: true
  xss_detection: true
  path_traversal_detection: true
  
  sanitization:
    html_tags_allowed:
      - "b"
      - "i"
      - "u"
      - "em"
      - "strong"
      - "p"
      - "br"
    auto_escape_html: true
    remove_null_bytes: true

# Security Headers Configuration
security_headers:
  enabled: true
  
  hsts:
    enabled: true
    max_age: 31536000  # 1 year
    include_subdomains: true
    preload: true
  
  csp:
    enabled: true
    default_src: "'self'"
    script_src: "'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://unpkg.com"
    style_src: "'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com"
    font_src: "'self' https://fonts.gstatic.com"
    img_src: "'self' data: https:"
    connect_src: "'self' https://api.pynomaly.com wss://api.pynomaly.com"
    frame_ancestors: "'none'"
    base_uri: "'self'"
    form_action: "'self'"
  
  other_headers:
    x_frame_options: "DENY"
    x_content_type_options: "nosniff"
    x_xss_protection: "1; mode=block"
    referrer_policy: "strict-origin-when-cross-origin"
    permissions_policy: "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), speaker=()"

# CORS Configuration
cors:
  enabled: true
  policy: "restrictive"  # restrictive, permissive, custom
  
  allowed_origins:
    - "https://pynomaly.com"
    - "https://app.pynomaly.com"
    - "https://dashboard.pynomaly.com"
  
  allowed_methods:
    - "GET"
    - "POST"
    - "PUT"
    - "DELETE"
    - "OPTIONS"
    - "PATCH"
  
  allowed_headers:
    - "Accept"
    - "Accept-Language"
    - "Content-Language"
    - "Content-Type"
    - "Authorization"
    - "X-Requested-With"
    - "X-CSRF-Token"
  
  expose_headers:
    - "Content-Length"
    - "Content-Type"
    - "X-RateLimit-Limit"
    - "X-RateLimit-Remaining"
    - "X-RateLimit-Reset"
  
  max_age: 86400  # 24 hours
  allow_credentials: true

# Encryption Configuration
encryption:
  enabled: true
  
  algorithms:
    symmetric: "AES-256-GCM"
    asymmetric: "RSA-2048"
    hash: "SHA-256"
    kdf: "PBKDF2"
  
  key_management:
    master_key: ${PYNOMALY_MASTER_KEY}  # Set via environment variable
    rotation_interval: 2592000  # 30 days
    backup_keys: 3
  
  field_encryption:
    enabled: true
    fields:
      - "email"
      - "phone"
      - "api_key"
      - "password_hash"
      - "personal_data"
  
  transit_encryption:
    tls_version: "1.3"
    cipher_suites:
      - "TLS_AES_256_GCM_SHA384"
      - "TLS_CHACHA20_POLY1305_SHA256"
      - "TLS_AES_128_GCM_SHA256"

# Security Monitoring Configuration
security_monitoring:
  enabled: true
  
  event_logging:
    level: "INFO"
    retention_days: 90
    structured_logs: true
    include_request_body: false  # For privacy
  
  real_time_monitoring:
    enabled: true
    alert_thresholds:
      authentication_failures: 5
      rate_limit_violations: 10
      sql_injection_attempts: 1
      xss_attempts: 1
      suspicious_file_uploads: 1
  
  intrusion_detection:
    enabled: true
    anomaly_threshold: 0.7
    learning_period_days: 7
    baseline_update_interval: 86400  # 24 hours
  
  alerting:
    enabled: true
    channels:
      - "email"
      - "slack"
      - "webhook"
    escalation_levels:
      - level: 1
        severity: ["medium"]
        delay_minutes: 15
      - level: 2
        severity: ["high"]
        delay_minutes: 5
      - level: 3
        severity: ["critical"]
        delay_minutes: 0

# Vulnerability Scanning Configuration
vulnerability_scanning:
  enabled: true
  
  schedule:
    automated_scans: true
    scan_frequency: "daily"
    scan_time: "02:00"  # 2 AM UTC
  
  scan_types:
    dependency_scan: true
    code_scan: true
    configuration_scan: true
    infrastructure_scan: false  # Requires external tools
  
  thresholds:
    max_critical: 0
    max_high: 5
    max_medium: 20
    max_low: 50
  
  notification:
    on_new_vulnerabilities: true
    on_severity_change: true
    summary_reports: "weekly"
  
  integration:
    github_security_advisories: true
    nvd_database: true
    snyk_integration: false

# Session Management Configuration
session_management:
  enabled: true
  
  session_timeout: 7200  # 2 hours
  absolute_timeout: 28800  # 8 hours
  session_id_length: 32
  
  security:
    secure_cookies: true
    http_only_cookies: true
    same_site: "strict"
    session_hijacking_detection: true
  
  cleanup:
    expired_session_cleanup: true
    cleanup_interval: 3600  # 1 hour

# API Security Configuration
api_security:
  versioning:
    deprecation_warnings: true
    version_sunset_period: 180  # 6 months
  
  request_validation:
    strict_content_type: true
    max_request_size: 104857600  # 100MB
    timeout: 30  # seconds
  
  response_security:
    remove_server_headers: true
    add_security_headers: true
    sanitize_error_messages: true
  
  audit_logging:
    log_all_requests: false
    log_failed_requests: true
    log_admin_actions: true
    log_data_access: true

# Compliance Configuration
compliance:
  frameworks:
    gdpr: true
    ccpa: true
    pci_dss: false
    hipaa: false
    sox: false
  
  data_retention:
    user_data: 2555  # 7 years in days
    log_data: 90    # 90 days
    audit_data: 2555 # 7 years
  
  privacy:
    data_anonymization: true
    right_to_deletion: true
    data_portability: true
    consent_management: true
  
  audit_trail:
    enabled: true
    immutable_logs: true
    log_integrity_checks: true
    retention_period: 2555  # 7 years

# Environment-Specific Overrides
environments:
  development:
    security_headers:
      csp:
        script_src: "'self' 'unsafe-inline' 'unsafe-eval' *"
    cors:
      allowed_origins:
        - "*"
    encryption:
      field_encryption:
        enabled: false
  
  staging:
    vulnerability_scanning:
      scan_frequency: "weekly"
    security_monitoring:
      alert_thresholds:
        authentication_failures: 10
  
  production:
    # Use all default settings (most restrictive)
    pass
